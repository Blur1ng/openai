=== Dockerfile ===
# Используем официальный образ Python
FROM python:3.13.3-alpine

# Устанавливаем рабочую директорию в контейнере
WORKDIR /app

# Копируем файлы проекта в контейнер
COPY . /app

# Копируем файл зависимостей и устанавливаем их
COPY requirements.txt .

# Устанавливаем зависимости
RUN pip install --no-cache-dir -r requirements.txt

# Экспонируем порт для FastAPI
EXPOSE 8000
---
=== Makefile ===
run:
	docker-compose up
build:
	docker-compose up --build
tests:
	docker exec -it exchange-rate-fastapi-1 pytest
---
=== README.md ===
# Ставки на курс криптовалюты

Проект позволяет пользователям делать ставки на изменение курса криптовалют (например, Bitcoin, Ethereum) за определённый промежуток времени. 
Пользователь выбирает направление (повышение/понижение), сумму ставки и время, через которое будет проверен результат. 
В основе проекта — микросервисная архитектура с использованием современных технологий.

---

## Технологии

- **Бэкенд**: 
  - `FastAPI` — фреймворк для создания API.
  - `SQLAlchemy` — ORM для работы с PostgreSQL.
  - `Pydantic` — валидация данных.
  - `Celery` — обработка отложенных задач.
  - `JWT` — аутентификация пользователей.
  - `Alembic` — управление миграциями баз данных.
  
- **Базы данных**:
  - `PostgreSQL` — основная БД для хранения пользователей и сделок.
  - `Redis` — брокер для Celery + временное хранение данных.

- **Фронтенд**:
  - `JavaScript` + `Fetch API` — взаимодействие с бэкендом.
  - `HTML`/`CSS` — интерфейс.

- **Внешние сервисы**:
  - `CoinMarketCap API` — получение актуальных курсов криптовалют.

---

## Ключевые особенности

### Регистрация и аутентификация
- Пользователь регистрируется с уникальным логином и паролем.
- При входе генерируется JWT-токен, который сохраняется в защищённых куках (`HttpOnly`, `Secure`, `SameSite=Strict`).
- Токен автоматически отправляется в заголовках запросов для доступа к защищённым эндпоинтам.

### Взаимодействие фронтенда и бэкенда
- Фронтенд отправляет запросы к API через `fetch()`.
- Примеры запросов:
  - Получение текущего курса криптовалюты.
  - Создание ставки с указанием времени.
  - Проверка статуса завершённых сделок.

### Отложенные задачи через Celery
- При создании ставки задача добавляется в очередь Redis с задержкой (`countdown`), равной выбранному пользователем времени.
- Celery Worker периодически проверяет очередь и выполняет задачи:
  1. Получает актуальный курс криптовалюты через CoinMarketCap API.
  2. Сравнивает с начальным курсом.
  3. Определяет результат ставки (выигрыш/проигрыш).
  4. Сохраняет результат в PostgreSQL.

### Базы данных
- **PostgreSQL**:
  - `Пользователи`: логин, хеш пароля.
  - `Сделки`: валюта, направление, сумма, время, статус.
  - `Результаты`: прибыль/убыток, время завершения.
- **Redis**:
  - Брокер для Celery.
  - Временное хранение данных о незавершённых сделках.

### ORM и миграции
- `SQLAlchemy` используется для моделей данных и запросов к PostgreSQL.
- `Alembic` управляет миграциями: создание таблиц, обновление схемы.

---

## Запуск проекта

### Требования:
- Python 3.10+
- Установленные PostgreSQL и Redis.
- API-ключ от CoinMarketCap.

### Инструкция:
1. Клонируйте репозиторий:
    ```bash
    git clone https://github.com/ваш-username/ставки-криптовалюты.git
    Установите зависимости:
    bash
    Copy

    pip install -r requirements.txt
    ```
2. Настройте переменные окружения (.env):
    ```ini
    DATABASE_URL=postgresql://user:password@localhost/dbname
    REDIS_URL=redis://localhost:6379/0
    CMC_API_KEY=ваш_api_ключ
    JWT_SECRET=секретный_ключ
    ```
3. Примените миграции:
    ```bash
    alembic upgrade head
    ```
4. Запустите серверы:
    ```bash
    # FastAPI
    uvicorn app.main:app --reload

    # Celery Worker
    celery -A core.celery_con.celery worker --loglevel=info --pool=solo

    # Redis
    redis-server
    ```
### Примеры API-запросов
1. Создание ставки
    ```http
    POST /api/v1/trade_it/
    Body:
    {
      "exchange": "BTC",
      "bet_amount": 100,
      "leverage": 5,
      "direction": "up",
      "time": 5,
      "start_price": 50000
    }
    ```
2. Проверка статуса
    ```http
    GET /api/v1/trade_status/20
    Response:
    {
      "status": "completed",
      "result": "W",
      "profit": 500
    }
    ```
Зачем нужен этот проект?
    - Учебный пример: Демонстрация интеграции FastAPI, Celery, JWT и современных инструментов разработки.
    - Практика: Реализация микросервисной архитектуры с асинхронными задачами.
    - Базовый функционал: Может быть расширен до полноценной торговой платформы.
---
=== alembic/README ===
Generic single-database configuration.
---
=== alembic/env.py ===
from logging.config import fileConfig

from sqlalchemy import engine_from_config
from sqlalchemy import pool

from alembic import context

import os
from dotenv import load_dotenv

load_dotenv()
database_url = os.getenv("DATABASE_URL")

# this is the Alembic Config object, which provides
# access to the values within the .ini file in use.
config = context.config
config.set_section_option("alembic", "sqlalchemy.url", database_url)
# Interpret the config file for Python logging.
# This line sets up loggers basically.
if config.config_file_name is not None:
    fileConfig(config.config_file_name)

# add your model's MetaData object here
# for 'autogenerate' support
# from myapp import mymodel
# target_metadata = mymodel.Base.metadata
from app.core.database_con import Base

target_metadata = Base.metadata

# other values from the config, defined by the needs of env.py,
# can be acquired:
# my_important_option = config.get_main_option("my_important_option")
# ... etc.


def run_migrations_offline() -> None:
    """Run migrations in 'offline' mode.

    This configures the context with just a URL
    and not an Engine, though an Engine is acceptable
    here as well.  By skipping the Engine creation
    we don't even need a DBAPI to be available.

    Calls to context.execute() here emit the given string to the
    script output.

    """
    url = config.get_main_option("sqlalchemy.url")
    context.configure(
        url=url,
        target_metadata=target_metadata,
        literal_binds=True,
        dialect_opts={"paramstyle": "named"},
    )

    with context.begin_transaction():
        context.run_migrations()


def run_migrations_online() -> None:
    """Run migrations in 'online' mode.

    In this scenario we need to create an Engine
    and associate a connection with the context.

    """
    connectable = engine_from_config(
        config.get_section(config.config_ini_section, {}),
        prefix="sqlalchemy.",
        poolclass=pool.NullPool,
    )

    with connectable.connect() as connection:
        context.configure(connection=connection, target_metadata=target_metadata)

        with context.begin_transaction():
            context.run_migrations()


if context.is_offline_mode():
    run_migrations_offline()
else:
    run_migrations_online()
---
=== alembic/script.py.mako ===
"""${message}

Revision ID: ${up_revision}
Revises: ${down_revision | comma,n}
Create Date: ${create_date}

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa
${imports if imports else ""}

# revision identifiers, used by Alembic.
revision: str = ${repr(up_revision)}
down_revision: Union[str, None] = ${repr(down_revision)}
branch_labels: Union[str, Sequence[str], None] = ${repr(branch_labels)}
depends_on: Union[str, Sequence[str], None] = ${repr(depends_on)}


def upgrade() -> None:
    ${upgrades if upgrades else "pass"}


def downgrade() -> None:
    ${downgrades if downgrades else "pass"}
---
=== alembic/versions/0052fb7c0e1b_rocket6.py ===
"""rocket6

Revision ID: 0052fb7c0e1b
Revises: 4fc62c8f6e0f
Create Date: 2025-03-12 11:56:08.322964

"""

from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql

# revision identifiers, used by Alembic.
revision: str = "0052fb7c0e1b"
down_revision: Union[str, None] = "4fc62c8f6e0f"
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_column("Rocket", "time_start")
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column(
        "Rocket",
        sa.Column(
            "time_start", postgresql.TIMESTAMP(), autoincrement=False, nullable=True
        ),
    )
    # ### end Alembic commands ###
---
=== alembic/versions/0698ea4e2bc5_rocket3.py ===
"""rocket3

Revision ID: 0698ea4e2bc5
Revises: 1054d511854c
Create Date: 2025-03-10 10:58:18.781700

"""

from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql

# revision identifiers, used by Alembic.
revision: str = "0698ea4e2bc5"
down_revision: Union[str, None] = "1054d511854c"
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column("Rocket", sa.Column("time_start", sa.DateTime(), nullable=True))
    op.add_column("Rocket", sa.Column("time_uspel", sa.DateTime(), nullable=True))
    op.drop_column("Rocket", "time")
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column(
        "Rocket",
        sa.Column("time", postgresql.TIMESTAMP(), autoincrement=False, nullable=True),
    )
    op.drop_column("Rocket", "time_uspel")
    op.drop_column("Rocket", "time_start")
    # ### end Alembic commands ###
---
=== alembic/versions/1054d511854c_rocket2.py ===
"""rocket2

Revision ID: 1054d511854c
Revises: feaab5a092cd
Create Date: 2025-03-08 13:43:33.319928

"""

from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = "1054d511854c"
down_revision: Union[str, None] = "feaab5a092cd"
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index("ix_Rocket_rocketX", table_name="Rocket")
    op.drop_column("Rocket", "rocketX")
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column(
        "Rocket",
        sa.Column(
            "rocketX",
            sa.DOUBLE_PRECISION(precision=53),
            autoincrement=False,
            nullable=True,
        ),
    )
    op.create_index("ix_Rocket_rocketX", "Rocket", ["rocketX"], unique=False)
    # ### end Alembic commands ###
---
=== alembic/versions/4fc62c8f6e0f_rocket5.py ===
"""rocket5

Revision ID: 4fc62c8f6e0f
Revises: b87c975d5f60
Create Date: 2025-03-11 07:12:55.463303

"""

from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql

# revision identifiers, used by Alembic.
revision: str = "4fc62c8f6e0f"
down_revision: Union[str, None] = "b87c975d5f60"
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column("Rocket", sa.Column("time_take_profit", sa.DateTime(), nullable=True))
    op.drop_column("Rocket", "time_start_start")
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column(
        "Rocket",
        sa.Column(
            "time_start_start",
            postgresql.TIMESTAMP(),
            autoincrement=False,
            nullable=True,
        ),
    )
    op.drop_column("Rocket", "time_take_profit")
    # ### end Alembic commands ###
---
=== alembic/versions/54971b2592c2_add_rocket.py ===
"""add Rocket

Revision ID: 54971b2592c2
Revises: 89d687c6f2ee
Create Date: 2025-03-03 05:33:05.570873

"""

from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = "54971b2592c2"
down_revision: Union[str, None] = "89d687c6f2ee"
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table(
        "Rocket",
        sa.Column("id", sa.Integer(), nullable=False),
        sa.Column("start_price", sa.Float(), nullable=True),
        sa.Column("end_price", sa.Float(), nullable=True),
        sa.Column("uspel", sa.Boolean(), nullable=True),
        sa.Column("rocketX", sa.Float(), nullable=True),
        sa.Column("endX", sa.Float(), nullable=True),
        sa.Column("time", sa.DateTime(), nullable=True),
        sa.Column("user_id", sa.Integer(), nullable=True),
        sa.ForeignKeyConstraint(
            ["user_id"],
            ["User_data.id"],
        ),
        sa.PrimaryKeyConstraint("id"),
    )
    op.create_index(op.f("ix_Rocket_id"), "Rocket", ["id"], unique=False)
    op.create_index(
        op.f("ix_Rocket_start_price"), "Rocket", ["start_price"], unique=False
    )
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index(op.f("ix_Rocket_start_price"), table_name="Rocket")
    op.drop_index(op.f("ix_Rocket_id"), table_name="Rocket")
    op.drop_table("Rocket")
    # ### end Alembic commands ###
---
=== alembic/versions/89d687c6f2ee_v2_0.py ===
"""v2.0

Revision ID: 89d687c6f2ee
Revises:
Create Date: 2025-02-27 08:02:33.218172

"""

from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = "89d687c6f2ee"
down_revision: Union[str, None] = None
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table(
        "Account_data",
        sa.Column("id", sa.Integer(), nullable=False),
        sa.Column("account_id", sa.Integer(), nullable=True),
        sa.Column("balance", sa.Float(), nullable=True),
        sa.Column("last_enter", sa.DateTime(), nullable=True),
        sa.Column("status", sa.String(), nullable=True),
        sa.Column("email", sa.String(length=100), nullable=True),
        sa.Column("is_verified", sa.Boolean(), nullable=True),
        sa.PrimaryKeyConstraint("id"),
    )
    op.create_index(
        op.f("ix_Account_data_account_id"), "Account_data", ["account_id"], unique=True
    )
    op.create_index(
        op.f("ix_Account_data_balance"), "Account_data", ["balance"], unique=False
    )
    op.create_index(
        op.f("ix_Account_data_email"), "Account_data", ["email"], unique=True
    )
    op.create_index(op.f("ix_Account_data_id"), "Account_data", ["id"], unique=False)
    op.create_index(
        op.f("ix_Account_data_status"), "Account_data", ["status"], unique=False
    )
    op.create_table(
        "Trade_result",
        sa.Column("id", sa.Integer(), nullable=False),
        sa.Column("trade_id", sa.Integer(), nullable=True),
        sa.Column("end_price", sa.Float(), nullable=True),
        sa.Column("money", sa.Float(), nullable=True),
        sa.PrimaryKeyConstraint("id"),
    )
    op.create_index(op.f("ix_Trade_result_id"), "Trade_result", ["id"], unique=False)
    op.create_index(
        op.f("ix_Trade_result_money"), "Trade_result", ["money"], unique=False
    )
    op.create_index(
        op.f("ix_Trade_result_trade_id"), "Trade_result", ["trade_id"], unique=True
    )
    op.create_table(
        "User_data",
        sa.Column("id", sa.Integer(), nullable=False),
        sa.Column("username", sa.String(), nullable=True),
        sa.Column("password", sa.String(), nullable=True),
        sa.Column("account_id", sa.Integer(), nullable=True),
        sa.ForeignKeyConstraint(
            ["account_id"],
            ["Account_data.account_id"],
        ),
        sa.PrimaryKeyConstraint("id"),
    )
    op.create_index(op.f("ix_User_data_id"), "User_data", ["id"], unique=False)
    op.create_index(
        op.f("ix_User_data_username"), "User_data", ["username"], unique=True
    )
    op.create_table(
        "Trade_data",
        sa.Column("id", sa.Integer(), nullable=False),
        sa.Column("exchange", sa.String(), nullable=True),
        sa.Column("bet_amount", sa.Float(), nullable=True),
        sa.Column("leverageX", sa.Integer(), nullable=True),
        sa.Column("direction", sa.String(), nullable=True),
        sa.Column("time", sa.DateTime(), nullable=True),
        sa.Column("start_price", sa.Float(), nullable=True),
        sa.Column("status", sa.String(), nullable=True),
        sa.Column("trade_result", sa.String(), nullable=True),
        sa.Column("user_id", sa.Integer(), nullable=True),
        sa.Column("result", sa.Integer(), nullable=True),
        sa.ForeignKeyConstraint(
            ["result"],
            ["Trade_result.trade_id"],
        ),
        sa.ForeignKeyConstraint(
            ["user_id"],
            ["User_data.id"],
        ),
        sa.PrimaryKeyConstraint("id"),
    )
    op.create_index(
        op.f("ix_Trade_data_bet_amount"), "Trade_data", ["bet_amount"], unique=False
    )
    op.create_index(
        op.f("ix_Trade_data_exchange"), "Trade_data", ["exchange"], unique=False
    )
    op.create_index(op.f("ix_Trade_data_id"), "Trade_data", ["id"], unique=False)
    op.create_index(
        op.f("ix_Trade_data_status"), "Trade_data", ["status"], unique=False
    )
    op.create_index(
        op.f("ix_Trade_data_trade_result"), "Trade_data", ["trade_result"], unique=False
    )
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index(op.f("ix_Trade_data_trade_result"), table_name="Trade_data")
    op.drop_index(op.f("ix_Trade_data_status"), table_name="Trade_data")
    op.drop_index(op.f("ix_Trade_data_id"), table_name="Trade_data")
    op.drop_index(op.f("ix_Trade_data_exchange"), table_name="Trade_data")
    op.drop_index(op.f("ix_Trade_data_bet_amount"), table_name="Trade_data")
    op.drop_table("Trade_data")
    op.drop_index(op.f("ix_User_data_username"), table_name="User_data")
    op.drop_index(op.f("ix_User_data_id"), table_name="User_data")
    op.drop_table("User_data")
    op.drop_index(op.f("ix_Trade_result_trade_id"), table_name="Trade_result")
    op.drop_index(op.f("ix_Trade_result_money"), table_name="Trade_result")
    op.drop_index(op.f("ix_Trade_result_id"), table_name="Trade_result")
    op.drop_table("Trade_result")
    op.drop_index(op.f("ix_Account_data_status"), table_name="Account_data")
    op.drop_index(op.f("ix_Account_data_id"), table_name="Account_data")
    op.drop_index(op.f("ix_Account_data_email"), table_name="Account_data")
    op.drop_index(op.f("ix_Account_data_balance"), table_name="Account_data")
    op.drop_index(op.f("ix_Account_data_account_id"), table_name="Account_data")
    op.drop_table("Account_data")
    # ### end Alembic commands ###
---
=== alembic/versions/b87c975d5f60_rocket4.py ===
"""rocket4

Revision ID: b87c975d5f60
Revises: 0698ea4e2bc5
Create Date: 2025-03-11 07:09:16.975638

"""

from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = "b87c975d5f60"
down_revision: Union[str, None] = "0698ea4e2bc5"
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column("Rocket", sa.Column("time_start_start", sa.DateTime(), nullable=True))
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_column("Rocket", "time_start_start")
    # ### end Alembic commands ###
---
=== alembic/versions/feaab5a092cd_rocket1.py ===
"""rocket1

Revision ID: feaab5a092cd
Revises: 54971b2592c2
Create Date: 2025-03-06 11:19:07.879758

"""

from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = "feaab5a092cd"
down_revision: Union[str, None] = "54971b2592c2"
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column("Rocket", sa.Column("start_bet", sa.Float(), nullable=True))
    op.add_column("Rocket", sa.Column("end_bet", sa.Float(), nullable=True))
    op.add_column("Rocket", sa.Column("zabrannyyX", sa.Float(), nullable=True))
    op.drop_index("ix_Rocket_start_price", table_name="Rocket")
    op.create_index(op.f("ix_Rocket_end_bet"), "Rocket", ["end_bet"], unique=False)
    op.create_index(op.f("ix_Rocket_rocketX"), "Rocket", ["rocketX"], unique=False)
    op.create_index(op.f("ix_Rocket_start_bet"), "Rocket", ["start_bet"], unique=False)
    op.create_index(op.f("ix_Rocket_uspel"), "Rocket", ["uspel"], unique=False)
    op.create_index(
        op.f("ix_Rocket_zabrannyyX"), "Rocket", ["zabrannyyX"], unique=False
    )
    op.drop_column("Rocket", "start_price")
    op.drop_column("Rocket", "end_price")
    op.drop_column("Rocket", "endX")
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column(
        "Rocket",
        sa.Column(
            "endX",
            sa.DOUBLE_PRECISION(precision=53),
            autoincrement=False,
            nullable=True,
        ),
    )
    op.add_column(
        "Rocket",
        sa.Column(
            "end_price",
            sa.DOUBLE_PRECISION(precision=53),
            autoincrement=False,
            nullable=True,
        ),
    )
    op.add_column(
        "Rocket",
        sa.Column(
            "start_price",
            sa.DOUBLE_PRECISION(precision=53),
            autoincrement=False,
            nullable=True,
        ),
    )
    op.drop_index(op.f("ix_Rocket_zabrannyyX"), table_name="Rocket")
    op.drop_index(op.f("ix_Rocket_uspel"), table_name="Rocket")
    op.drop_index(op.f("ix_Rocket_start_bet"), table_name="Rocket")
    op.drop_index(op.f("ix_Rocket_rocketX"), table_name="Rocket")
    op.drop_index(op.f("ix_Rocket_end_bet"), table_name="Rocket")
    op.create_index("ix_Rocket_start_price", "Rocket", ["start_price"], unique=False)
    op.drop_column("Rocket", "zabrannyyX")
    op.drop_column("Rocket", "end_bet")
    op.drop_column("Rocket", "start_bet")
    # ### end Alembic commands ###
---
=== alembic.ini ===
# A generic, single database configuration.

[alembic]
# path to migration scripts
# Use forward slashes (/) also on windows to provide an os agnostic path
script_location = alembic

# template used to generate migration file names; The default value is %%(rev)s_%%(slug)s
# Uncomment the line below if you want the files to be prepended with date and time
# see https://alembic.sqlalchemy.org/en/latest/tutorial.html#editing-the-ini-file
# for all available tokens
# file_template = %%(year)d_%%(month).2d_%%(day).2d_%%(hour).2d%%(minute).2d-%%(rev)s_%%(slug)s

# sys.path path, will be prepended to sys.path if present.
# defaults to the current working directory.
prepend_sys_path = .

# timezone to use when rendering the date within the migration file
# as well as the filename.
# If specified, requires the python>=3.9 or backports.zoneinfo library and tzdata library.
# Any required deps can installed by adding `alembic[tz]` to the pip requirements
# string value is passed to ZoneInfo()
# leave blank for localtime
# timezone =

# max length of characters to apply to the "slug" field
# truncate_slug_length = 40

# set to 'true' to run the environment during
# the 'revision' command, regardless of autogenerate
# revision_environment = false

# set to 'true' to allow .pyc and .pyo files without
# a source .py file to be detected as revisions in the
# versions/ directory
# sourceless = false

# version location specification; This defaults
# to alembic/versions.  When using multiple version
# directories, initial revisions must be specified with --version-path.
# The path separator used here should be the separator specified by "version_path_separator" below.
# version_locations = %(here)s/bar:%(here)s/bat:alembic/versions

# version path separator; As mentioned above, this is the character used to split
# version_locations. The default within new alembic.ini files is "os", which uses os.pathsep.
# If this key is omitted entirely, it falls back to the legacy behavior of splitting on spaces and/or commas.
# Valid values for version_path_separator are:
#
# version_path_separator = :
# version_path_separator = ;
# version_path_separator = space
# version_path_separator = newline
#
# Use os.pathsep. Default configuration used for new projects.
version_path_separator = os

# set to 'true' to search source files recursively
# in each "version_locations" directory
# new in Alembic version 1.10
# recursive_version_locations = false

# the output encoding used when revision files
# are written from script.py.mako
# output_encoding = utf-8
# localhost
sqlalchemy.url = ${DATABASE_URL}


[post_write_hooks]
# post_write_hooks defines scripts or Python functions that are run
# on newly generated revision scripts.  See the documentation for further
# detail and examples

# format using "black" - use the console_scripts runner, against the "black" entrypoint
# hooks = black
# black.type = console_scripts
# black.entrypoint = black
# black.options = -l 79 REVISION_SCRIPT_FILENAME

# lint with attempts to fix using "ruff" - use the exec runner, execute a binary
# hooks = ruff
# ruff.type = exec
# ruff.executable = %(here)s/.venv/bin/ruff
# ruff.options = --fix REVISION_SCRIPT_FILENAME

# Logging configuration
[loggers]
keys = root,sqlalchemy,alembic

[handlers]
keys = console

[formatters]
keys = generic

[logger_root]
level = WARNING
handlers = console
qualname =

[logger_sqlalchemy]
level = WARNING
handlers =
qualname = sqlalchemy.engine

[logger_alembic]
level = INFO
handlers =
qualname = alembic

[handler_console]
class = StreamHandler
args = (sys.stderr,)
level = NOTSET
formatter = generic

[formatter_generic]
format = %(levelname)-5.5s [%(name)s] %(message)s
datefmt = %H:%M:%S
---
=== app/__init__.py ===
---
=== app/api/__init__.py ===
---
=== app/api/anotherAPI/__init__.py ===
---
=== app/api/anotherAPI/currency.py ===
from fastapi import HTTPException
from app.core.security import CMC_API_KEY
import requests


def get_crypto_price(coin_ticket: str):
    url = "https://pro-api.coinmarketcap.com/v1/cryptocurrency/listings/latest"

    headers = {
        "X-CMC_PRO_API_KEY": CMC_API_KEY,
        "Accept": "application/json",
    }
    params = {"convert": "USD"}
    try:
        response = requests.get(url, headers=headers, params=params)

        data = response.json()
        coin_ticket = coin_ticket.upper()
        coin_price = next(
            item for item in data["data"] if item["symbol"] == coin_ticket
        )["quote"]["USD"]["price"]
        return {f"{coin_ticket}USDT": coin_price}
    except Exception as e:
        raise HTTPException(
            status_code=500,
            detail=f"Unexpected error: {e if e else "Try in a few seconds"}",
        )
---
=== app/api/classes/__init__.py ===
---
=== app/api/classes/account.py ===
import random


class ConfimEmail:
    SIMBOL_LIST = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz1234567890"

    async def create_confim_url(self):
        user_url = ""
        for _ in range(10):
            user_url += self.SIMBOL_LIST[random.randint(0, 61)]
        return user_url
---
=== app/api/classes/clsss.py ===
from fastapi import HTTPException
from app.core.database_con import User, Account_Data, AsyncSession
from app.api.models.users import User_Form
from sqlalchemy.future import select
import re
from datetime import datetime, timedelta, UTC
import random
import httpx
from app.api.anotherAPI.currency import get_crypto_price


class UserEnterData:
    def __init__(self, user: User_Form):
        self.user = user

    def check_password(self) -> bool:
        """
        Проверка пароля на достаточную надежность
        """
        forbidden_symbols = r'[!@#$%^&*()_+=\-\[\]{}|\\:";\'<>,.?/]'
        password = self.user.password
        if 6 <= len(password) <= 17 and not re.search(forbidden_symbols, password):
            return False
        return True

    def check_username(self) -> bool:
        """
        Проверка юсернейма на валидность
        Проверка на допустимые символы (буквы, цифры, дефисы, подчеркивания)
        """
        forbidden_symbols = r'[!@#$%^&*()+=\-\[\]{}|\\:";\'<>,.?/]'
        username = self.user.username
        if 3 <= len(username) <= 17 and not re.search(forbidden_symbols, username):
            return False
        return True


class AccountEnterData:
    @staticmethod
    def check_email(email: str) -> bool:
        """
        Проверка email на валидность
        """
        email_regex = r"^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$"
        if re.match(email_regex, email):
            return True
        return False


class GetData:
    def __init__(self, db: AsyncSession, table: User | Account_Data):
        self.db = db
        self.table = table

    async def from_id(self, id: int):
        try:
            table = self.table
            result = await self.db.execute(select(table).filter(table.id == id))
            data = result.scalar_one_or_none()
            return data
        except Exception as e:
            print(f"ERROR: {id} is not a 'id' ")

    async def from_user_id(self, id: int):
        try:
            table = self.table
            result = await self.db.execute(select(table).filter(table.user_id == id))
            data = result.scalar_one_or_none()
            return data
        except Exception as e:
            print(f"ERROR: {id} is not a 'user_id' ")

    async def from_trade_id(self, id: int):
        try:
            table = self.table
            result = await self.db.execute(select(table).filter(table.trade_id == id))
            data = result.scalar_one_or_none()
            return data
        except Exception as e:
            print(f"ERROR: {id} is not a 'id' ")

    async def from_account_id(self, account_id: int):
        try:
            table = self.table
            result = await self.db.execute(
                select(table).filter(table.account_id == account_id)
            )
            data = result.scalar_one_or_none()
            return data
        except Exception as e:
            print(f"ERROR: {id} is not a 'account_id' ")

    async def from_username(self, username):
        try:
            table = self.table
            result = await self.db.execute(
                select(table).filter(table.username == username)
            )
            data = result.scalar_one_or_none()
            return data
        except Exception as e:
            print(f"ERROR: {username} is not a 'user_name' ")

    async def from_token(self, token):
        try:
            async with httpx.AsyncClient() as client:
                cookies = {"access_token": token}
                response = await client.get(
                    f"http://fastapi:8000/api/v1/verify_jwt_token/", cookies=cookies
                )
            username = response.json()
            if "detail" in username:
                return "no token"
            username = username["user_name"]
            return await self.from_username(username)

        except Exception as e:
            return HTTPException(
                status_code=401,
                detail="Токен не найден",
                headers={"WWW-Authenticate": "Bearer"},
            )


class UserData:
    def __init__(self, db: AsyncSession, user: User):
        self.db = db
        self.user = user

    async def update_balance(self, update: float) -> None:
        user_id = self.user.account_id
        db = self.db
        try:
            account = await GetData(db, Account_Data).from_account_id(user_id)
            account.balance += update
            await db.commit()
            await db.refresh(account)
        except Exception as e:
            print("[-] Аккаунт не найден")

    async def update_status(self):
        pass

    async def update_email(self, update):
        user_id = self.user.account_id
        db = self.db
        try:
            account = await GetData(db, Account_Data).from_account_id(user_id)
            account.email = update
            await db.commit()
            await db.refresh(account)
        except Exception as e:
            print("[-] Аккаунт не найден")

    async def update_is_verified(self):
        pass

    async def update_last_enter(self):
        pass

    async def update_username(self):
        pass

    async def update_password(self):
        pass


class Exchange:
    def __init__(self, exchange: str):
        self.exchange = exchange

    def get_current_exchange(self):
        try:
            response = get_crypto_price(self.exchange)
            return response[f"{self.exchange}USDT"]
        except Exception as e:
            return e


class RandomData:
    def __init__(self, limit: int, start: int = 0):
        self.limit = limit
        self.start = start

    async def get_time(self):
        seconds = random.randint(self.start, self.limit)
        milliseconds = random.randint(1, 999)
        time = datetime.now(UTC) + timedelta(seconds=seconds, milliseconds=milliseconds)
        return time


class Casino:
    @staticmethod
    async def get_second(time: datetime):
        t_ms = time.microsecond / 1_000_000
        t_s = time.second + t_ms
        return t_s

    @staticmethod
    async def get_zabrannyyX(time_start: datetime, time_take_profit: datetime):
        ts_s = await Casino.get_second(time_start)
        ttp_s = await Casino.get_second(time_take_profit)
        return (ttp_s - ts_s) * 100
---
=== app/api/endpoints/__init__.py ===
---
=== app/api/endpoints/account.py ===
from fastapi import APIRouter, HTTPException, Depends, Request, status

from app.core.database_con import AsyncSession, User, get_db, redis_client

from app.api.classes.clsss import AccountEnterData, GetData, UserData
from app.api.classes.account import ConfimEmail

from app.core.security import get_jwt_from_cookie
from fastapi.templating import Jinja2Templates

import jwt

import logging

logger = logging.getLogger(__name__)


templates = Jinja2Templates("app/templates")

router_account = APIRouter()


@router_account.post("/api/v1/update_account/{email}/")
async def update_account(
    email: str,
    db: AsyncSession = Depends(get_db),
    token: str = Depends(get_jwt_from_cookie),
):
    if AccountEnterData.check_email(email):
        user: User = await GetData(db, User).from_token(token)
        await UserData(db, user).update_email(email)

        # Создаем ссылку подтверждения email
        verify_email = await ConfimEmail().create_confim_url()
        print(verify_email)
        await redis_client.set(f"{verify_email}", f"{user.id}", ex=300)

        return {
            "email": email,
        }
    raise HTTPException(
        status_code=401, detail=f"Invalid email", headers={"WWW-Authenticate": "Bearer"}
    )


@router_account.get("/verify-email/{user_url}")
async def verify_email(
    request: Request,
    user_url: str,
    db: AsyncSession = Depends(get_db),
    token: str = Depends(get_jwt_from_cookie),
):
    try:
        user_id = await redis_client.get(f"{user_url}")
        if not user_id:
            raise HTTPException(
                status_code=status.HTTP_404_NOT_FOUND,
                detail="Срок действия ссылки истек",
            )
        user_id = int(user_id.decode())
        user: User = await GetData(db, User).from_id(user_id)
        if not user:
            raise HTTPException(
                status_code=status.HTTP_404_NOT_FOUND, detail="Пользователь не найден"
            )
        user.is_verified = True
        return templates.TemplateResponse(
            "verify_email.html",
            {"request": request, "title": "VERIFIED EMAIL", "token": token},
        )
    except jwt.PyJWTError:
        raise HTTPException(
            status_code=status.HTTP_400_BAD_REQUEST,
            detail="Что то пошло не так, повторите позже",
        )
---
=== app/api/endpoints/rocket.py ===
import asyncio
import json
from datetime import datetime, timedelta, timezone
from fastapi import APIRouter, Depends, WebSocket, WebSocketDisconnect
from fastapi.responses import RedirectResponse

from app.core.database_con import AsyncSession, get_db, Rocket, User
from app.api.classes.clsss import GetData, RandomData, UserData

router_rocket = APIRouter()

START_ROCKET_TIME = 0
LIMIT_ROCKET_TIME = 9
USLOZHNENIYE = 2  # Усложнение игры. Чем больше, тем раньше закончится ракетка. max=8
UTC = timezone.utc


async def increase_multiplier(websocket: WebSocket, multiplier_state: dict):
    try:
        k = 0.1
        while True:
            multiplier_state["value"] += k
            multiplier_state["value"] = round(multiplier_state["value"], 1)
            if multiplier_state["value"] > 8:
                k = 1
            elif multiplier_state["value"] > 4:
                k = 0.3
            elif multiplier_state["value"] == 1.5:
                k = 0.1

            await websocket.send_json(
                {"action": "update_multiplier", "value": multiplier_state["value"]}
            )

            await asyncio.sleep(0.1)
    except asyncio.CancelledError:
        raise


@router_rocket.websocket("/api/v1/ws/rocket/")
async def rocket_con(websocket: WebSocket, db: AsyncSession = Depends(get_db)):
    """
    1. Приходит ставка
    2. Рассчитывается: время через какое нужно успеть забрать time_uspel
    3. Если пользователь успел нажать кнопку "Забрать X", то uspel = True
    4. В случае, если время вышло, на фронт приходит сообщение: "ракетка улетела", uspel = False
    5. В случае успеха end_bet=start_bet*zabrannyyX, иначе end_bet=0
    """
    await websocket.accept()
    multiplier_task = None
    zabrannyyX = 0

    multiplier_state = {"value": 0}

    try:
        while True:
            data = await websocket.receive_text()
            message = json.loads(data)
            action = message.get("action")

            token = websocket.cookies.get("access_token")

            user = await GetData(db, User).from_token(token)
            if user == "no token":
                await websocket.close()
                return RedirectResponse(url="/")

            if action == "start_bet":
                start_bet = int(message.get("betValue"))
                time_uspel = await RandomData(
                    start=START_ROCKET_TIME, limit=LIMIT_ROCKET_TIME
                ).get_time()
                time_uspel = time_uspel.replace(tzinfo=None)
                rocket = Rocket(
                    start_bet=start_bet,
                    time_uspel=time_uspel - timedelta(seconds=USLOZHNENIYE),
                    user_id=user.id,
                )

                db.add(rocket)
                await db.commit()
                await db.refresh(rocket)

                multiplier_state["value"] = 0

                # включение счетчика
                multiplier_task = asyncio.create_task(
                    increase_multiplier(websocket, multiplier_state)
                )

            if action == "take_profit":
                # отключение счетчика
                if multiplier_task and not multiplier_task.done():
                    zabrannyyX = multiplier_state["value"]
                    multiplier_task.cancel()
                else:
                    zabrannyyX = multiplier_state["value"]

                time_take_profit = datetime.now(timezone.utc).replace(tzinfo=None)
                rocket.time_take_profit = time_take_profit
                result = time_uspel - time_take_profit - timedelta(seconds=USLOZHNENIYE)
                end_bet = rocket.start_bet
                if result.days == 0:
                    uspel = True
                    # обновление икса на финальное значение
                    zabrannyyX = multiplier_state["value"]
                    end_bet = round(end_bet * zabrannyyX, 2)
                    await UserData(db, user).update_balance(end_bet)
                else:
                    uspel = False
                    zabrannyyX = 0
                    await UserData(db, user).update_balance(-end_bet)

                rocket.end_bet = end_bet
                rocket.uspel = uspel
                rocket.zabrannyyX = zabrannyyX

                await db.commit()
                await db.refresh(rocket)

                if uspel:
                    await websocket.send_json({"status": "WIN", "end_bet": end_bet})
                else:
                    await websocket.send_json({"status": "Lose", "end_bet": end_bet})
                await websocket.close()
                break

    except WebSocketDisconnect:
        if multiplier_task and not multiplier_task.done():
            multiplier_task.cancel()
        await websocket.close()
---
=== app/api/endpoints/users.py ===
from fastapi import APIRouter, HTTPException, Depends, Response
from fastapi import WebSocket, WebSocketDisconnect
from datetime import datetime, timedelta, UTC

from fastapi.responses import RedirectResponse

from app.api.models.users import User_Form
from app.webapp.models.trade import Trade_Form
from app.core.database_con import (
    AsyncSession,
    redis_client,
    User,
    Trade,
    Account_Data,
    Trade_Result,
    get_db,
)
from app.core.security import (
    pwd_context,
    create_jwt_token,
    verify_jwt_token,
    get_jwt_from_cookie,
)

from app.core.celery_con import celery, process_trade

from app.api.classes.clsss import GetData, UserEnterData, UserData, Exchange

import asyncio


router_users = APIRouter()

TOKEN_LIFE_TIME = 120  # minutes


@router_users.post("/api/v1/auth/register/")
async def register(enter_data: User_Form, db: AsyncSession = Depends(get_db)):
    """
    Регистрация пользователя и проверка вводимых данных
    """
    user = UserEnterData(enter_data)
    if user.check_password():
        raise HTTPException(401, "[-] Weak password")
    if user.check_username():
        raise HTTPException(401, "[-] Invalid username")
    try:
        hash_password = pwd_context.hash(enter_data.password)
        user = User(username=enter_data.username, password=hash_password)
        db.add(user)
        await db.commit()
        await db.refresh(user)
        user = await GetData(db, User).from_username(user.username)

        account = Account_Data(account_id=user.id)
        db.add(account)
        await db.commit()
        await db.refresh(account)

        user.account_id = user.id
        await db.commit()
        await db.refresh(user)
        return {"Registration was successful"}
    except Exception as e:
        raise HTTPException(status_code=401, detail="Username already exists")


async def check_for_past_tense(username: str) -> bool:
    """
    Проверка заблокирован ли пользователь
    Функция не дает пользователю войти, если он все еще в бан листе
    Даже, если он ввел верные данные, система их не проверяет
    """
    block_key = f"blocked:{username}"
    block_time = await redis_client.get(block_key)

    if block_time:
        block_time = datetime.fromisoformat(block_time.decode())
        if datetime.now() > block_time:
            # Разблокировать пользователя
            await redis_client.delete(block_key)
            await redis_client.delete(f"wrong_attempts:{username}")
            return True
        return False
    return True


async def anti_password_selection_system(username: str) -> bool:
    """
    Анти-спам система для попыток входа
    При 5 неправильных попытках ввода пользователь помещается в бан лист,
    Где ожидает следующих попыток
    """
    attempts_key = f"wrong_attempts:{username}"
    wrong_attempts = await redis_client.get(attempts_key)

    if wrong_attempts:
        wrong_attempts = int(wrong_attempts.decode())
        wrong_attempts += 1
    else:
        wrong_attempts = 1

    await redis_client.set(attempts_key, wrong_attempts, ex=60)

    if wrong_attempts >= 5:
        # Блокируем пользователя на 1 минуту
        block_key = f"blocked:{username}"
        await redis_client.set(
            block_key, (datetime.now() + timedelta(minutes=1)).isoformat(), ex=60
        )
        return True
    return False


@router_users.post("/api/v1/auth/login/")
async def login(
    user_data: User_Form, response: Response, db: AsyncSession = Depends(get_db)
):
    """
    Вход юзера в систему с созданием jwt токена
    Также идет проверка на username, password и, при неправильно вводимых данных
    Вызывается функция анти_подбора_паролей() (anti_password_selection_system())
    """
    username = user_data.username
    user = await GetData(db, User).from_username(username)

    if (
        await check_for_past_tense(username)
        and user
        and pwd_context.verify(user_data.password, user.password)
    ):
        # Время жизни токена
        token_lifetime = datetime.now(UTC) + timedelta(minutes=TOKEN_LIFE_TIME)
        token = create_jwt_token({"username": username, "exp": token_lifetime})
        # Устанавливаем токен в защищенные куки
        response.set_cookie(
            "access_token",
            token,
            max_age=TOKEN_LIFE_TIME * 60,
            expires=TOKEN_LIFE_TIME,
            httponly=True,  # только серверу, а не клиентскому JavaScript.
            secure=True,  # https only
            samesite="Strict",  # ограничивает отправку cookie только с того же домена.
        )
        return {"message": "[+] Login successful"}

    if await anti_password_selection_system(username):
        raise HTTPException(
            status_code=429,
            detail="Too many attempts, try again in a few minutes",
            headers={"WWW-Authenticate": "Bearer"},
        )

    raise HTTPException(
        status_code=401,
        detail="Invalid credentials",
        headers={"WWW-Authenticate": "Bearer"},
    )


@router_users.get("/api/v1/verify_jwt_token/")
async def verify_jwt_token_point(verify: dict = Depends(verify_jwt_token)):
    return {"user_name": verify}


@router_users.post("/api/v1/trade_it/")
async def trade_it(
    trade_data: Trade_Form,
    db: AsyncSession = Depends(get_db),
    token: str = Depends(get_jwt_from_cookie),
):
    """
    Сохранения результатов сделки в postgre
    """
    time = datetime.now(UTC) + timedelta(
        minutes=trade_data.time
    )  # Переводим из int в datetime

    exchange = trade_data.exchange
    bet_amount = trade_data.bet_amount
    leverageX = trade_data.leverage
    direction = trade_data.direction
    time_naive = time.replace(
        tzinfo=None
    )  # Преобразуем в naive datetime (без временной зоны)
    start_price = Exchange(trade_data.exchange).get_current_exchange()
    user = await GetData(db, User).from_token(token)
    if user == "no token":
        return RedirectResponse(url="/")
    user_id = user.id

    trade = Trade(
        exchange=exchange,
        bet_amount=bet_amount,
        leverageX=leverageX,
        direction=direction,
        time=time_naive,
        start_price=start_price,
        user_id=user_id,
    )

    db.add(trade)
    await db.commit()
    await db.refresh(trade)

    # Фоновая задача
    process_trade.apply_async(
        args=[trade.id], countdown=trade_data.time * 60  # Задержка в секундах
    )
    return {"trade_id": trade.id, "start_price": start_price}


@router_users.websocket("/api/v1/ws/trade_status/{trade_id}")
async def websocket_trade_status(
    websocket: WebSocket, trade_id: int, db: AsyncSession = Depends(get_db)
):
    await websocket.accept()

    try:
        while True:
            # Используем отдельную сессию для каждого запроса
            async with db.begin():
                trade = await GetData(db, Trade).from_id(trade_id)

                if not trade:
                    try:
                        await websocket.send_json({"error": "Trade not found"})
                    except WebSocketDisconnect:
                        return
                    break

                # Принудительно обновляем данные
                await db.refresh(trade)

                if trade.status != "pending":
                    trade_result = await GetData(db, Trade_Result).from_trade_id(
                        trade_id
                    )

                    response = {
                        "status": trade.status,
                        "result": trade.trade_result,
                        "end_price": trade_result.end_price,
                        "timestamp": datetime.now().isoformat(),
                    }

                    try:
                        await websocket.send_json(response)
                        user = await GetData(db, User).from_id(trade.user_id)
                        await UserData(db, user).update_balance(trade_result.money)

                        await websocket.close()
                    except WebSocketDisconnect:
                        return
                    break

            await asyncio.sleep(3)

    except WebSocketDisconnect:
        return
---
=== app/api/models/__init__.py ===
---
=== app/api/models/users.py ===
from pydantic import BaseModel


class User_Form(BaseModel):
    id: int | None = None
    username: str
    password: str

    class Config:
        from_attributes = True
---
=== app/core/__init__.py ===
---
=== app/core/celery_con.py ===
from celery import Celery
from .database_con import Trade, Trade_Result, sync_session
from app.api.classes.clsss import Exchange


celery = Celery(
    "tasks", broker=f"redis://redis:6379/0", backend=f"redis://redis:6379/1"
)
celery.conf.update(broker_connection_retry_on_startup=True)


@celery.task(name="core.celery_con.process_trade")
def process_trade(trade_id: int):
    """
    Используем синхронный подход как для функции так и для подключению к бд
    Получаем результат ставки, заносим его в бд и возвращаем статус, результат(W/L)
    """
    session = sync_session()
    try:
        trade = session.query(Trade).filter(Trade.id == trade_id).first()
        if not trade:
            return {"status": "error", "message": "Trade not found"}

        try:
            # Обращаемся к api и узнаем текущий курс
            end_price = Exchange(trade.exchange).get_current_exchange()

            if (end_price > trade.start_price and trade.direction == "up") or (
                end_price < trade.start_price and trade.direction == "down"
            ):
                result = "W"
                profit = trade.bet_amount * trade.leverageX
            else:
                result = "L"
                profit = -trade.bet_amount * trade.leverageX

            trade_result = Trade_Result(
                trade_id=trade.id, end_price=end_price, money=profit
            )
            session.add(trade_result)
            session.commit()
            session.refresh(trade_result)

            trade.status = "completed"
            trade.trade_result = result
            trade.result = trade.id
            session.commit()
            session.begin()
            session.refresh(trade)

            return {"status": "completed", "result": result}

        except Exception as e:
            trade.status = "failed"
            session.commit()
            return {"status": "error", "message": str(e)}

    finally:
        session.close()
---
=== app/core/database_con.py ===
from sqlalchemy.ext.asyncio import AsyncSession, create_async_engine
from sqlalchemy.orm import declarative_base
from sqlalchemy.orm import sessionmaker
import redis.asyncio as redis
from sqlalchemy import (
    Column,
    Integer,
    String,
    DateTime,
    ForeignKey,
    Float,
    Boolean,
    create_engine,
)
from .security import DB_PASSWORD, POSTGRES_DB, POSTGRES_USER


# Синхронная сессия
sinc_engine = create_engine(
    f"postgresql+psycopg2://{POSTGRES_USER}:{DB_PASSWORD}@db:5432/{POSTGRES_DB}"
)
sync_session = sessionmaker(bind=sinc_engine)

# Асинхронная сессия
SQLACHEMY_DATABASE_URL = (
    f"postgresql+asyncpg://{POSTGRES_USER}:{DB_PASSWORD}@db:5432/{POSTGRES_DB}"
)
engine = create_async_engine(SQLACHEMY_DATABASE_URL)


Base = declarative_base()

async_session = sessionmaker(engine, class_=AsyncSession, expire_on_commit=False)


class Trade(Base):
    __tablename__ = "Trade_data"

    id = Column(Integer, primary_key=True, index=True)
    exchange = Column(String, index=True)
    bet_amount = Column(Float, index=True)
    leverageX = Column(Integer)
    direction = Column(String)
    time = Column(DateTime)
    start_price = Column(Float)
    status = Column(String, index=True, default="pending")
    trade_result = Column(String, index=True, default="pending")  # W/L

    user_id = Column(Integer, ForeignKey("User_data.id"))
    result = Column(Integer, ForeignKey("Trade_result.trade_id"))


class Trade_Result(Base):
    __tablename__ = "Trade_result"

    id = Column(Integer, primary_key=True, index=True)
    trade_id = Column(Integer, index=True, unique=True)
    end_price = Column(Float, nullable=True)
    money = Column(Float, index=True)


class User(Base):
    __tablename__ = "User_data"

    id = Column(Integer, primary_key=True, index=True)
    username = Column(String, index=True, unique=True)
    password = Column(String)

    account_id = Column(Integer, ForeignKey("Account_data.account_id"))


class Account_Data(Base):
    __tablename__ = "Account_data"

    id = Column(Integer, primary_key=True, index=True)
    account_id = Column(Integer, index=True, unique=True)
    balance = Column(Float, index=True, default=0.0)
    last_enter = Column(DateTime)
    status = Column(String, index=True, default="Offline")
    email = Column(String(100), unique=True, index=True)
    is_verified = Column(Boolean, default=False)


class Rocket(Base):
    __tablename__ = "Rocket"

    id = Column(Integer, primary_key=True, index=True)
    start_bet = Column(Float, index=True)
    end_bet = Column(Float, index=True)
    uspel = Column(Boolean, index=True)
    zabrannyyX = Column(Float, index=True)
    time_take_profit = Column(DateTime)
    time_uspel = Column(DateTime)

    user_id = Column(Integer, ForeignKey("User_data.id"))


# redis
redis_client = redis.from_url(f"redis://redis:6379", db=0)


async def get_db():
    # Сессия с бд
    async with async_session() as db:
        yield db
---
=== app/core/security.py ===
from dotenv import load_dotenv
import os
from fastapi import Depends, HTTPException, Request
import jwt

from passlib.context import CryptContext

load_dotenv()

SECRET_KEY = os.getenv("SECRET_KEY")
ALGORITHM = os.getenv("ALGORITHM")
CMC_API_KEY = os.getenv("CMC_API_KEY")
FIXER_API_KEY = os.getenv("FIXER_API_KEY")
DB_PASSWORD = os.getenv("DB_PASSWORD")
POSTGRES_USER = os.getenv("DB_USER")
POSTGRES_PASSWORD = os.getenv("DB_PASSWORD")
POSTGRES_DB = os.getenv("DB_NAME")


pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")


def create_jwt_token(payload: dict):
    """Создание JWT токена"""
    return jwt.encode(payload, SECRET_KEY, algorithm=ALGORITHM)


def get_jwt_from_cookie(request: Request):
    """Получение Cookie"""
    token = request.cookies.get("access_token")
    if not token:
        return None
    return token


async def verify_jwt_token(token: str = Depends(get_jwt_from_cookie)):
    """Верификация JWT токена"""
    if token is None:
        raise HTTPException(
            status_code=401,
            detail="[-] No token found",
            headers={"WWW-Authenticate": "Bearer"},
        )
    try:
        payload = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])
        return payload["username"]
    except jwt.ExpiredSignatureError:
        raise HTTPException(
            status_code=401,
            detail="The token has expired",
            headers={"WWW-Authenticate": "Bearer"},
        )
    except jwt.PyJWTError:
        raise HTTPException(
            status_code=401,
            detail="Invalid token",
            headers={"WWW-Authenticate": "Bearer"},
        )
---
=== app/main.py ===
from fastapi import FastAPI
from app.api.endpoints.users import router_users
from app.api.endpoints.account import router_account
from app.api.endpoints.rocket import router_rocket
from app.webapp.endpoints.main_back import router_main_back
from fastapi.staticfiles import StaticFiles
import uvicorn


app = FastAPI()

app.include_router(router_users)
app.include_router(router_main_back)
app.include_router(router_account)
app.include_router(router_rocket)

app.mount("/static", StaticFiles(directory="app/static"), name="static")

if __name__ == "__main__":
    uvicorn.run(app, host="0.0.0.0", port=8000)
---
=== app/static/css/navbar.css ===
/* Навбар */
.navbar {
    background-color: #1e1e1e; /* Тёмный фон */
    padding: 1rem 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5); /* Тень */
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 1000; /* Чтобы навбар был поверх других элементов */
}

.navbar-brand .brand-link {
    font-size: 1.5rem;
    font-weight: bold;
    color: #00ff88; /* Акцентный цвет */
    text-decoration: none;
    text-transform: uppercase;
    letter-spacing: 2px;
}

/* Список ссылок */
.navbar-nav {
    list-style: none;
    display: flex;
    gap: 1.5rem;
    margin: 0;
    padding: 0;
}

/* Ссылки */
.nav-link {
    color: #ffffff; /* Белый цвет текста */
    text-decoration: none;
    font-size: 1.3rem;
    font-weight: 500;
    padding: 0.5rem 1rem;
    border-radius: 5px;
    transition: background-color 0.3s ease, color 0.3s ease;
}

/* Эффекты при наведении */
.nav-link:hover {
    background-color: rgba(0, 255, 136, 0.1); /* Лёгкий акцентный оттенок */
    color: #00ff88; /* Акцентный цвет */
}

/* Активная ссылка */
.nav-link.active {
    background-color: rgba(0, 255, 136, 0.2);
    color: #00ff88;
}

@media (max-width: 768px) {
    .navbar {
        flex-direction: column;
        padding: 1rem;
    }

    .navbar-nav {
        flex-direction: column;
        gap: 0.5rem;
        margin-top: 1rem;
    }

    .nav-link {
        padding: 0.5rem;
        text-align: center;
    }
}
---
=== app/static/js/acc_email.js ===
document.getElementById("email-form").addEventListener("submit", async function(event) {
    event.preventDefault();  // Отменяем стандартное поведение формы (переход по URL)

    const newEmail = document.getElementById("new_email").value;
    
    try {
        const response = await fetch(`/api/v1/update_account/${newEmail}/`, { 
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const data = await response.json();

        if (response.ok) {
            showNotification(data.message || 'Email успешно обновлен!', 'success');
        } else {
            showNotification(data.message || 'Ошибка при обновлении email', 'error');
        }
    } catch (error) {
        showNotification('Ошибка при подключении к серверу', 'error');
    }
});

function showNotification(message, type) {
    const notification = document.getElementById('email-notification');
    const messageSpan = document.getElementById('email-message');
    messageSpan.textContent = message;

    if (type === 'success') {
        notification.style.backgroundColor = 'rgba(144, 238, 144, 0.8)';  // Зеленый
    } else {
        notification.style.backgroundColor = 'rgba(255, 99, 71, 0.8)';  // Красный
    }

    notification.classList.add('show');
    setTimeout(() => {
        notification.classList.remove('show');
    }, 5000);  // Скрыть уведомление через 5 секунд
}
---
=== app/static/js/check_token.js ===
document.addEventListener("DOMContentLoaded", async function () {
    try {
        const response = await fetch("/api/v1/verify_jwt_token/", {
            method: "GET",
            credentials: "include",
        });

        if (!response.ok) {
            // Если токен недействителен, перенаправляем на страницу входа
            window.location.href = "/login";
            return;
        }

        // Если токен действителен, загружаем страницу
    } catch (error) {
        console.error("Error verifying JWT token:", error);
        window.location.href = "/login";
    }
});
---
=== app/static/js/login.js ===
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('login-form');
    const errorMessage = document.getElementById('error-message');  // Если есть элемент для ошибок
    form.addEventListener('submit', async function(event) {
        event.preventDefault();  // Предотвращаем перезагрузку страницы

        const username = document.querySelector('input[name="username"]').value;
        const password = document.querySelector('input[name="password"]').value;

        const loginData = {
            username: username,
            password: password
        };

        try {
            const response = await fetch('/api/v1/auth/login/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(loginData),
            });

            if (response.ok) {
                const data = await response.json();
                window.location.href = '/';
            } else {
                const errorData = await response.json();
                if (errorMessage) {
                    errorMessage.textContent = errorData.detail;
                }
            }
        } catch (error) {
            if (errorMessage) {
                errorMessage.textContent = 'Произошла ошибка. Попробуйте позже.';
            }
        }
    });
});
---
=== app/static/js/register.js ===
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('register-form');
    const errorMessage = document.getElementById('error-message');  // Если есть элемент для ошибок

    form.addEventListener('submit', async function(event) {
        event.preventDefault();  // Предотвращаем перезагрузку страницы

        const username = document.querySelector('input[name="username"]').value;
        const password = document.querySelector('input[name="password"]').value;
        const confirmPassword = document.querySelector('input[name="confirm_password"]').value;

        // Проверяем совпадение паролей
        if (password !== confirmPassword) {
            if (errorMessage) {
                errorMessage.textContent = 'Пароли не совпадают!';
            }
            return;  // Останавливаем выполнение, если пароли не совпадают
        }

        const registerData = {
            username: username,
            password: password
        };

        try {
            const response = await fetch('/api/v1/auth/register/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(registerData),
            });

            if (response.ok) {
                const data = await response.json();
                window.location.href = '/login';  // Перенаправление на страницу входа
            } else {
                const errorData = await response.json();
                if (errorMessage) {
                    errorMessage.textContent = errorData.detail;
                }
            }
        } catch (error) {
            if (errorMessage) {
                errorMessage.textContent = 'Произошла ошибка. Попробуйте позже.';
            }
        }
    });
});
---
=== app/static/js/rocket.js ===
document.addEventListener("DOMContentLoaded", () => {
    let ws
    let currentMultiplier = 0
    let gameActive = false
  
    const resultContainer = document.getElementById("result")
    const multiplierContainer = document.getElementById("multiplierContainer")
    const multiplierValue = document.getElementById("multiplierValue")
    const takeProfitBtn = document.getElementById("takeProfitBtn")
    const submitBtn = document.getElementById("submitBtn")
    const betInput = document.getElementById("start_bet")
    const rocketAnimation = document.getElementById("rocketAnimation")
    const rocket = document.getElementById("rocket")
  
    // Reset game
    function resetGame() {
      gameActive = false
      currentMultiplier = 0
      multiplierValue.textContent = "0.0x"
      multiplierValue.classList.remove("pulse")
      takeProfitBtn.classList.remove("show")
      multiplierContainer.classList.remove("show")
      resultContainer.classList.remove("show")
      rocketAnimation.classList.remove("active")
      rocket.classList.remove("fly-away")
      submitBtn.disabled = false
      betInput.disabled = false
    }
  
    // Start game
    submitBtn.addEventListener("click", async (e) => {
      e.preventDefault()
  
      const betAmount = betInput.value
      if (!betAmount || betAmount < 10) {
        alert("Минимальная ставка: 10")
        return
      }
  
      resetGame()
      gameActive = true
  
      submitBtn.disabled = true
      betInput.disabled = true
  
      multiplierContainer.classList.add("show")
      rocketAnimation.classList.add("active")
  
      ws = new WebSocket(`ws://${window.location.host}/api/v1/ws/rocket/`)
  
      const message = {
        action: "start_bet",
        betValue: betAmount,
      }
  
      ws.onopen = () => {
        ws.send(JSON.stringify(message))
        takeProfitBtn.classList.add("show")
        multiplierValue.classList.add("pulse")
      }
  
      ws.onmessage = (event) => {
        const data = JSON.parse(event.data)
  
        if (data.action === "update_multiplier") {
          currentMultiplier = data.value
          multiplierValue.textContent = `${currentMultiplier.toFixed(1)}x`
  
          // добавления анимации ракете обновл позиции
          const rocketPosition = Math.min(currentMultiplier * 10, 100)
          rocket.style.bottom = `${rocketPosition}%`
        } else if (data.status) {
          gameActive = false
          multiplierValue.classList.remove("pulse")
  
          if (data.status === "WIN") {
            resultContainer.innerHTML = `<span class="result-win">ПОБЕДА! +${data.end_bet}₽</span>`

          } else {
            resultContainer.innerHTML = `<span class="result-lose">ПРОИГРЫШ -${data.end_bet}₽</span>`

            rocket.classList.add("fly-away")
          }
  
          resultContainer.classList.add("show")
          takeProfitBtn.classList.remove("show")
  
          setTimeout(() => {
            submitBtn.disabled = false
            betInput.disabled = false
          }, 1500)
        }
      }
  
      ws.onerror = (error) => {
        console.error("WebSocket error:", error)
        resetGame()
        resultContainer.innerHTML = `<span class="result-lose">Ошибка соединения</span>`
        resultContainer.classList.add("show")
      }
  
      ws.onclose = () => {
        if (gameActive) {
          resetGame()
          resultContainer.innerHTML = `<span class="result-lose">Соединение прервано</span>`
          resultContainer.classList.add("show")
        }
      }
    })
  
    takeProfitBtn.addEventListener("click", (e) => {
      e.preventDefault()
  
      if (!gameActive) return
  
      const message = {
        action: "take_profit",
      }
  
      ws.send(JSON.stringify(message))
      takeProfitBtn.classList.remove("show")
    })
  })
  
  
---
=== app/static/js/trade_front.js ===
document.addEventListener("DOMContentLoaded", function () {
    const form = document.getElementById("tradeForm");
    const resultContainer = document.getElementById("result");
    const container_peredv = document.getElementById("container-peredv");
    const container_show1 = document.getElementById("container1-show");
    const price_show = document.getElementById("price-show");
    const container_show2 = document.getElementById("container2-show");
    const current_show = document.getElementById("current-show");

    form.addEventListener("submit", async function (e) {
        e.preventDefault();
        try {
            // Формируем данные для отправки
            const formData = {
                exchange: document.getElementById("currency").value,
                bet_amount: parseFloat(document.getElementById("amount").value),
                leverage: parseInt(document.getElementById("leverage").value),
                direction: document.getElementById("direction").value,
                time: parseInt(document.getElementById("time").value),
            };
            // 2 Отправляем данные для сохранения ставки
            const tradeResponse = await fetch("/api/v1/trade_it/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                credentials: "include",
                body: JSON.stringify(formData),
            });
            const result = await tradeResponse.json();
        
            resultContainer.innerText = `Сделка создана! ID: ${result.trade_id}`;
            resultContainer.classList.add("show");
            
            //смещение контейнера
            container_peredv.classList.add("show");  
            
            // контейнтейнеры цен
            price_show.innerText = `${formData.exchange}:  ${result.start_price.toFixed(4)}$`;
            container_show1.classList.add("show");
            

            // Функция для проверки статуса
            function connectWebSocket(tradeId) {
                const ws = new WebSocket(`ws://${window.location.host}/api/v1/ws/trade_status/${tradeId}`);
            
                ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    
                    if (data.error) {
                        console.error('WebSocket error:', data.error);
                        return;
                    }
            
                    if (data.status === "completed") {
                        current_show.innerText = `${formData.exchange}:  ${data.end_price.toFixed(4)}$`;
                        container_show2.classList.add("show");
                        resultContainer.innerText = data.result === "W" 
                            ? `Победа! +${formData.bet_amount * formData.leverage}₽`
                            : `Проигрыш -${formData.bet_amount * formData.leverage}₽`;
                    } 
                    else if (data.status === "failed") {
                        resultContainer.innerText = `Trade: ${tradeId} was failed`;
                    }
                };
            }         
            connectWebSocket(result.trade_id);
            
        } catch (error) {
            resultContainer.innerText = "Ошибка: " + error.message;
            resultContainer.classList.add("show");
            console.error(error)
        }
    });
});
---
=== app/templates/account.html ===
{% extends "base.html" %}


{% block title %}{{ title }}{% endblock %}

{% block content %}
<style>
    body {
        background-color: #121212;
    }
    :root {
        --primary: #00ff88;
        --dark-1: #1a1a1a;
        --dark-2:rgb(31, 31, 31);
        --text: #e0e0e0;
        --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .account-container {    
        max-width: 1400px;
        margin: 4rem auto;
        padding: 2rem;
        color: var(--text);
    }

    .profile-section {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 2rem;
        margin-top: 2rem;
    }

    .account-card {
        background: linear-gradient(145deg, var(--dark-1), var(--dark-2));
        border-radius: 16px;
        padding: 2.5rem;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.25);
        margin-bottom: 2rem;
        border: 1px solid rgba(255, 255, 255, 0.05);
        transition: var(--transition);
        color: var(--text);
    }

    .account-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 40px rgba(0, 255, 136, 0.15);
    }

    .account-info-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.2rem 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    }

    .account-info-item span:first-child {
        color: var(--primary);
        font-weight: 500;
    }

    .account-info-item span:last-child {
        color: var(--text);
        font-weight: 400;
    }

    .account-form {
        display: flex;
        flex-direction: column;
        gap: 2rem;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 0.8rem;
        position: relative;
    }

    .form-label {
        color: var(--primary);
        font-weight: 500;
        font-size: 0.95rem;
        letter-spacing: 0.5px;
    }

    .form-input {
        background: rgba(0, 0, 0, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        padding: 1rem 1.5rem;
        color: var(--text);
        font-size: 1rem;
        transition: var(--transition);
    }

    .form-input:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(0, 255, 136, 0.15);
        background: rgba(0, 0, 0, 0.3);
    }

    .update-button {
        background: linear-gradient(135deg, var(--primary) 0%, #00cc6a 100%);
        color: var(--dark-1);
        border: none;
        padding: 1.2rem 2.5rem;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
        letter-spacing: 0.5px;
        transition: var(--transition);
        position: relative;
        overflow: hidden;
    }

    .update-button::after {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: linear-gradient(45deg, 
            transparent 25%, 
            rgba(255, 255, 255, 0.1) 50%, 
            transparent 75%);
        transform: rotate(45deg);
        transition: var(--transition);
    }

    .update-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(0, 255, 136, 0.2);
    }

    .update-button:hover::after {
        animation: shine 1.5s infinite;
    }

    .balance-display {
        font-size: 2.8rem;
        color: var(--primary);
        text-align: center;
        margin: 2.5rem 0;
        font-weight: 600;
        text-shadow: 0 4px 20px rgba(0, 255, 136, 0.3);
    }

    .security-alert {
        background: rgba(0, 255, 136, 0.08);
        border-left: 4px solid var(--primary);
        padding: 1.2rem;
        margin: 1.5rem 0;
        border-radius: 8px;
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .security-alert::before {
        content: '🔒';
        font-size: 1.4rem;
    }

    .divider {
        border: none;
        height: 1px;
        background: rgba(255, 255, 255, 0.1);
        margin: 2rem 0;
    }

    @keyframes shine {
        0% { left: -50%; }
        100% { left: 150%; }
    }

    @media (max-width: 768px) {
        .account-container {
            padding: 1rem;
            margin-top: 2rem;
        }
        
        .account-card {
            padding: 1.5rem;
        }
        
        .balance-display {
            font-size: 2rem;
        }
        
        .account-info-item {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.5rem;
        }
    
        .email-notification {
            position: fixed;
            bottom: 20px;   /* Отступ от нижнего края */
            right: 20px;    /* Отступ от правого края */
            background-color: rgba(144, 238, 144, 0.8); /* Зеленый цвет для успеха */
            color: white;
            padding: 15px 25px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
            opacity: 0;
            transform: translateY(20px);  /* Сдвиг вниз для анимации */
            transition: all 0.3s ease-out;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .email-notification.show {
            opacity: 1;
            transform: translateY(0); /* Нормальное положение уведомления */
        }
        
        .email-notification.error {
            background-color: rgba(255, 99, 71, 0.8); /* Красный цвет для ошибки */
        }
        
    }
</style>
<body>
    <div class="account-container">
        <h1>Профиль пользователя</h1>
        
        <!-- Блок с балансом -->
        <div class="account-card">
            <div class="balance-display">
                Ваш баланс: {{ balance }}₽
            </div>
        </div>

        <div class="profile-section">
            <!-- Основная информация -->
            <div class="account-card">
                <h2>Основные данные</h2>
                <div class="account-info-item">
                    <span>Имя пользователя:</span>
                    <span>{{ username }}</span>
                </div>
                <div class="account-info-item">
                    <span>Email:</span>
                    <span>{{ email }}</span>
                </div>
                <div class="account-info-item">
                    <span>Верифицированный аккаунт: </span>
                    {% if is_verified %}
                        <span>YES</span>
                    {% else %}
                        <span>NO</span>
                    {% endif %}
                </div>
            </div>

            <!-- Формы изменения данных -->
            <div class="account-card">
                <h2>Настройки аккаунта</h2>

                <!-- Форма изменения email -->
                <form class="account-form" id="email-form">
                    <h3>Изменить Email</h3>
                    <div class="form-group">
                        <label class="form-label" for="new_email">Новый Email:</label>
                        <input class="form-input" type="email" id="new_email" name="new_email" required>
                    </div>
                    <button class="update-button" type="submit">Обновить Email</button>
                </form>

                <hr class="divider">

                <!-- Форма изменения пароля -->
                <form class="account-form" action="/update-password">
                    <h3>Изменить Пароль</h3>
                    <div class="form-group">
                        <label class="form-label" for="current_password">Текущий пароль:</label>
                        <input class="form-input" type="password" id="current_password" name="current_password" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="new_password">Новый пароль:</label>
                        <input class="form-input" type="password" id="new_password" name="new_password" required>
                    </div>
                    <button class="update-button" type="submit">Обновить Пароль</button>
                </form>

                    Для изменения важных данных требуется подтверждение по email
                </div>
            </div>
        </div>
        <!-- Уведомление об изменении email -->
        <div id="email-notification" class="email-notification">
            <span id="email-message"></span>
        </div>
    <script src="/static/js/acc_email.js"></script>
</body>
{% endblock %}
---
=== app/templates/base.html ===
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="{{ url_for('static', path='/images/favicon.ico') }}" type="image/x-icon">
    <title>{% block title %}{% endblock %}</title>
    <link rel="stylesheet" href="/static/css/navbar.css">
</head>
<body>
    <nav class="navbar">
        <div class="navbar-brand" style="text-shadow: 0px 0px 10px rgb(0, 0, 0);">
            <a href="/" class="brand-link">NENAEBALOVO.RU</a>
        </div>
        
        <ul class="navbar-nav" style="gap: 15rem;">
            <li><a href="/" class="nav-link">Главная</a></li>
            {% if token %}
                <li><a href="/trade" class="nav-link">Торговля</a></li>
                <li><a href="/rocket" class="nav-link">Ракетка🚀🤑</a></li>
            {% endif %}

        </ul>
    
        <ul class="navbar-nav">
            {% if token %}
                <li><a href="/account" class="nav-link">Профиль</a></li>
            {% else %}
                <li><a href="/login" class="nav-link">Войти</a></li>
            {% endif %}
        </ul>
    </nav>
    <main>
        {% block content %}{% endblock %}
    </main>
</body>
</html>
---
=== app/templates/email/verification.html ===
<html>
<body>
    <div style="display: flex; align-items: center; justify-content: center; flex-direction: column;">
        <h3>verification_html</h3>
        <p>Спасибо за регистрацию, {{ username }}!</p>
        <p>Для подтверждения вашего email, пожалуйста, перейдите по ссылке:</p>
        <a href="{{ verification_url }}">Подтвердить email</a>
        <p>Ссылка действительна в течение 24 часов.</p>
    </div>
</body>
</html>
---
=== app/templates/login.html ===
{% extends "base.html" %}


{% block title %}{{ title }}{% endblock %}

{% block content %}
<style>
    body {
        background-color: #333333;
        font-family: 'Arial', sans-serif;
        margin: 0;
        padding: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        color: white;
    }
    
    .container {
        background-color: #212121;
        padding: 40px;
        border-radius: 15px;
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.8);
        width: 350px;
        text-align: center;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        position: relative;
    }

    h2 {
        margin-bottom: 20px;
        font-size: 28px;
        color: #BB86FC;
    }
    .divider {
        width: 100%;
        height: 1px;
        background-color: #444444;
        margin: 20px 0;
    }

    .input-field {
        margin: 10px 0;
        width: 100%;
        padding: 12px;
        background-color: #2c2c2c;
        border: 1px solid #444444;
        border-radius: 8px;
        color: white;
        font-size: 16px;
    }

    .input-field:focus {
        outline: none;
        background-color: #383838;
        border-color: #BB86FC;
    }

    .login-btn {
        margin-top: 20px;
        padding: 12px 20px;
        background-color: #BB86FC;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    .login-btn:hover {
        background-color: #9e65f3;
    }
    .register-link {
        display: block;
        margin-top: 20px;
        color: #BB86FC;
        text-decoration: none;
    }
    .register-link:hover {
        text-decoration: underline;
    }
    .forgot-password-link {
        display: block;
        margin-top: 10px;
        color: #BB86FC;
        text-decoration: none;
    }
    .forgot-password-link:hover {
        text-decoration: underline;
    }
    .container::after {
        content: "";
        position: absolute;
        width: 70px;
        height: 3px;
        background-color: #BB86FC;
        left: 50%;
        transform: translateX(-50%);
        bottom: -20px;
    }
</style>

<body>

    <div class="container">
        <h2>WELCOME</h2>
        <form id="login-form">
            <input type="text" name="username" class="input-field" placeholder="Username" required>
            <input type="password" name="password" class="input-field" placeholder="Password" required>
            <div id="error-message" style="color: red;"></div>
            <button type="submit" class="login-btn">Login</button>
        </form>

        <div class="divider"></div>

        <a href="/register" class="register-link">Create an Account</a>
    </div>
    <script src="/static/js/login.js"></script>
</body>
{% endblock %}

---
=== app/templates/mainpage.html ===
{% extends "base.html" %}


{% block title %}{{ title }}{% endblock %}

{% block content %}
<style>
    :root {
        --accent: #00ff88;
        --accent-hover: #00cc66;
        --dark: #1e1e1e;
        --darker: #121212;
        --danger: #FF5252;
    }
    body {
        background-color: var(--darker);
        color: white;
        font-family: 'Inter', 'Segoe UI', 'Arial', sans-serif;
        margin: 0;
        line-height: 1.6;
    }
   
    .hero {
        padding: 8rem 2rem;
        text-align: center;
        background: linear-gradient(45deg, var(--dark), var(--darker));
        position: relative;
        overflow: hidden;
    }
    
    .hero::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(circle at center, rgba(0, 255, 136, 0.1) 0%, rgba(0, 0, 0, 0) 70%);
        z-index: 0;
    }
    
    .hero .container {
        position: relative;
        z-index: 1;
    }
    
    .hero h1 {
        font-size: 3.5rem;
        margin-bottom: 1.5rem;
        background: linear-gradient(to right, var(--accent), var(--accent-hover));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        font-weight: 800;
    }
    
    .hero p {
        font-size: 1.2rem;
        max-width: 600px;
        margin: 0 auto 2rem;
        color: rgba(255, 255, 255, 0.8);
    }
    
    /* Секция шагов */
    .steps {
        padding: 6rem 2rem;
        background-color: var(--dark);
    }
    
    .section-title {
        text-align: center;
        font-size: 2.5rem;
        margin-bottom: 3rem;
        color: var(--accent);
        font-weight: 700;
    }
    
    .step-card {
        background: var(--darker);
        padding: 2rem;
        border-radius: 15px;
        margin: 1rem;
        transition: all 0.3s ease;
        max-width: 300px;
        border: 1px solid rgba(255, 255, 255, 0.05);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }
    
    .step-card:hover {
        transform: translateY(-10px);
        border-color: var(--accent);
        box-shadow: 0 15px 40px rgba(0, 255, 136, 0.1);
    }
    
    .step-number {
        width: 50px;
        height: 50px;
        background: var(--accent);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: var(--dark);
        margin-bottom: 1rem;
        font-size: 1.2rem;
    }
    
    /* Сетка */
    .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 3rem;
        max-width: 1200px;
        margin: 0 auto;
    }
    
    /* Кнопки */
    .cta-button {
        background: var(--accent);
        color: var(--dark);
        padding: 1rem 2rem;
        border-radius: 30px;
        text-decoration: none;
        font-weight: bold;
        transition: all 0.3s ease;
        display: inline-block;
        margin: 0.5rem;
        border: none;
        cursor: pointer;
    }
    
    .cta-button:hover {
        transform: scale(1.05);
        box-shadow: 0 0 15px var(--accent);
        background: var(--accent-hover);
    }
    
    .cta-button.secondary {
        background: transparent;
        border: 2px solid var(--accent);
        color: var(--accent);
    }
    
    .cta-button.secondary:hover {
        background: rgba(0, 255, 136, 0.1);
        box-shadow: 0 0 15px rgba(0, 255, 136, 0.3);
    }
    
    .cta-button.danger {
        background: var(--danger);
        color: white;
    }
    
    .cta-button.danger:hover {
        box-shadow: 0 0 15px var(--danger);
        background: #ff3333;
    }
    
    /* Секция преимуществ */
    .features {
        padding: 6rem 2rem;
        background: var(--darker);
    }

    .features .container {
        max-width: 1200px;
        margin: 0 auto;
    }

    .features h2 {
        text-align: center;
        font-size: 2.5rem;
        margin-bottom: 4rem;
        color: var(--accent);
        font-weight: 700;
    }

    .feature-card {
        background: var(--dark);
        padding: 2rem;
        border-radius: 15px;
        text-align: center;
        transition: all 0.3s ease;
        border: 1px solid rgba(255, 255, 255, 0.05);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }

    .feature-card:hover {
        transform: translateY(-10px);
        border-color: var(--accent);
        box-shadow: 0 15px 40px rgba(0, 255, 136, 0.1);
    }

    .feature-card img {
        width: 80px;
        height: 80px;
        margin-bottom: 1.5rem;
        filter: invert(0.8);
        transition: filter 0.3s ease;
    }

    .feature-card:hover img {
        filter: invert(0.9) sepia(1) hue-rotate(80deg) saturate(5);
    }

    .feature-card h4 {
        color: var(--accent);
        margin: 1rem 0;
        font-size: 1.4rem;
        font-weight: 700;
    }

    .feature-card p {
        color: #cccccc;
        font-size: 1rem;
        line-height: 1.6;
    }
    
    .feature-card .tag {
        display: inline-block;
        padding: 0.3rem 0.8rem;
        background: rgba(0, 255, 136, 0.1);
        color: var(--accent);
        border-radius: 20px;
        font-size: 0.8rem;
        margin-bottom: 1rem;
    }
    
    .rocket-game {
        padding: 6rem 2rem;
        background: linear-gradient(135deg, var(--dark), var(--darker));
        position: relative;
        overflow: hidden;
    }
    
    .rocket-game::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        width: 50%;
        height: 100%;
        background: radial-gradient(circle at right, rgba(255, 82, 82, 0.1) 0%, rgba(0, 0, 0, 0) 70%);
        z-index: 0;
    }
    
    .rocket-game .container {
        position: relative;
        z-index: 1;
        max-width: 1200px;
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    
    .rocket-game h2 {
        text-align: center;
        font-size: 2.5rem;
        margin-bottom: 1.5rem;
        color: var(--danger);
        font-weight: 700;
    }
    
    .rocket-game p {
        text-align: center;
        max-width: 800px;
        margin: 0 auto 3rem;
        color: rgba(255, 255, 255, 0.8);
        font-size: 1.1rem;
    }
    
    .rocket-preview {
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: 100%;
        margin-bottom: 3rem;
    }
    
    .rocket-image {
        flex: 1;
        padding: 2rem;
        text-align: center;
    }
    
    .rocket-image img {
        max-width: 100%;
        height: auto;
        border-radius: 15px;
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
    }
    
    .rocket-features {
        flex: 1;
        padding: 2rem;
    }
    
    .rocket-feature {
        display: flex;
        align-items: flex-start;
        margin-bottom: 1.5rem;
    }
    
    .rocket-feature-icon {
        width: 40px;
        height: 40px;
        background: var(--danger);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 1rem;
        flex-shrink: 0;
    }
    
    .rocket-feature-icon span {
        font-size: 1.2rem;
        color: white;
    }
    
    .rocket-feature-text h4 {
        margin: 0 0 0.5rem;
        color: white;
        font-size: 1.2rem;
    }
    
    .rocket-feature-text p {
        margin: 0;
        text-align: left;
        color: rgba(255, 255, 255, 0.7);
        font-size: 1rem;
    }
    
    @media (max-width: 992px) {
        .rocket-preview {
            flex-direction: column;
        }
        
        .rocket-image, .rocket-features {
            width: 100%;
            padding: 1rem;
        }
    }
    
    @media (max-width: 768px) {
        .hero h1 {
            font-size: 2.5rem;
        }
        
        .section-title, .features h2, .rocket-game h2 {
            font-size: 2rem;
        }
        
        .features, .steps, .rocket-game {
            padding: 4rem 1rem;
        }
        
        .grid {
            gap: 1.5rem;
        }
    }
</style>

<body>
    <section class="hero">
        <div class="container">
            <h1>Торгуйте криптовалютой с умом</h1>
            <p>Делайте прогнозы, ставьте и получайте прибыль на изменении курсов</p>
            <div>
                {% if token %}
                    <a href="/trade" class="cta-button">Начать торговлю</a>
                {% else %}
                    <a href="/login" class="cta-button">Начать торговлю</a>
                {% endif %}
            </div>
        </div>
    </section>

    <section class="rocket-game">
        <div class="container">
            <h2>Ракетка 🚀</h2>
            <p>Испытайте свою удачу! Сделайте ставку, запустите ракету и заберите выигрыш до того, как она улетит.</p>
            
            <div class="rocket-preview">
                <div class="rocket-image">
                    <img src="/static/images/rocket-game-preview.jpg" alt="Игра Ракетка" onerror="this.src='/static/images/rocket2.png'; this.style.maxWidth='300px';">
                </div>
                
                <div class="rocket-features">
                    <div class="rocket-feature">
                        <div class="rocket-feature-icon">
                            <span>⏱️</span>
                        </div>
                        <div class="rocket-feature-text">
                            <h4>Растущий множитель</h4>
                            <p>Чем дольше летит ракета, тем выше множитель вашей ставки. Но не ждите слишком долго!</p>
                        </div>
                    </div>
                    
                    <div class="rocket-feature">
                        <div class="rocket-feature-icon">
                            <span>💰</span>
                        </div>
                        <div class="rocket-feature-text">
                            <h4>Огромные иксы</h4>
                            <p>Успейте забрать огромный икс до того, как ракета улетит, иначе вы потеряете свою ставку.</p>
                        </div>
                    </div>
                    
                    <div class="rocket-feature">
                        <div class="rocket-feature-icon">
                            <span>🎮</span>
                        </div>
                        <div class="rocket-feature-text">
                            <h4>Простой геймплей</h4>
                            <p>Минимум правил, максимум адреналина. Делайте ставку и решайте, когда забрать выигрыш.</p>
                        </div>
                    </div>
                    
                    {% if token %}
                        <a href="/rocket" class="cta-button danger">Играть сейчас</a>
                    {% else %}
                        <a href="/login" class="cta-button danger">Войти и играть</a>
                    {% endif %}
                </div>
            </div>
        </div>
    </section>

    <!-- Как это работает -->
    <section class="steps">
        <h2 class="section-title">Как это работает</h2>
        <div class="grid">
            <div class="step-card">
                <div class="step-number">1</div>
                <h3>Выбирайте актив</h3>
                <p>BTC, ETH, SOL и другие популярные криптовалюты</p>
                <p>Монеты</p>
            </div>

            <div class="step-card">
                <div class="step-number">2</div>
                <h3>Делайте ставку</h3>
                <p>Выбирайте направление (LONG/SHORT) и срок экспирации</p>
                <p>Торговля</p>
            </div>

            <div class="step-card">
                <div class="step-number">3</div>
                <h3>Получайте результат</h3>
                <p>Фиксируйте прибыль при правильном прогнозе</p>
                <p>Прибыль</p>
            </div>
        </div>
    </section>

    <!-- Преимущества -->
    <section class="features">
        <div class="container">
            <h2>Почему выбирают нас?</h2>
            <div class="grid">
                <div class="feature-card">
                    <div>
                        <span class="tag">Безопасность</span>
                        <h4>Максимальная безопасность</h4>
                        <p>Все транзакции защищены банковским уровнем шифрования, средства хранятся в холодных кошельках</p>
                    </div>
                </div>
                
                <div class="feature-card">
                    <div>
                        <span class="tag">Плечо</span>
                        <h4>Плечо до 100x</h4>
                        <p>Увеличивайте свою потенциальную прибыль с помощью кредитного плеча</p>
                    </div>
                </div>
                
                <div class="feature-card">
                    <div>
                        <span class="tag">Поддержка</span>
                        <h4>Круглосуточная поддержка</h4>
                        <p>Наша команда поддержки всегда готова помочь на русском и английском языках</p>
                    </div>
                </div>
                
            </div>
        </div>
    </section>
</body>
{% endblock %}

---
=== app/templates/register.html ===
{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<style>
    body {
        background-color: #333333;
        font-family: 'Arial', sans-serif;
        margin: 0;
        padding: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        color: white;
    }
    .container {
        background-color: #212121;
        padding: 40px;
        border-radius: 15px;
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.8);
        width: 350px;
        text-align: center;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        position: relative;
    }
    h2 {
        margin-bottom: 20px;
        font-size: 28px;
        color: #BB86FC;
    }
    .divider {
        width: 100%;
        height: 1px;
        background-color: #444444;
        margin: 20px 0;
    }
    .input-field {
        margin: 10px 0;
        width: 100%;
        padding: 12px;
        background-color: #2c2c2c;
        border: 1px solid #444444;
        border-radius: 8px;
        color: white;
        font-size: 16px;
    }
    .input-field:focus {
        outline: none;
        background-color: #383838;
        border-color: #BB86FC;
    }
    .register-btn {
        margin-top: 20px;
        padding: 12px 20px;
        background-color: #BB86FC;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }
    .register-btn:hover {
        background-color: #9e65f3;
    }
    .login-link {
        display: block;
        margin-top: 20px;
        color: #BB86FC;
        text-decoration: none;
    }
    .login-link:hover {
        text-decoration: underline;
    }
    .container::after {
        content: "";
        position: absolute;
        width: 70px;
        height: 3px;
        background-color: #BB86FC;
        left: 50%;
        transform: translateX(-50%);
        bottom: -20px;
    }
    #error-message {
        color: red;
        margin-top: 10px;
    }
</style>

<body>

    <div class="container">
        <h2>Регистрация</h2>
        <form id="register-form">
            <input type="text" name="username" class="input-field" placeholder="Username" required>
            <input type="password" name="password" class="input-field" placeholder="Password" required>
            <input type="password" name="confirm_password" class="input-field" placeholder="Confirm Password" required>
            <div id="error-message" style="color: red;"></div>
            <button type="submit" class="register-btn">Register</button>
        </form>

        <div class="divider"></div>

        <a href="/login" class="login-link">Уже есть аккаунт? Войти</a>
    </div>
    <script src="/static/js/register.js"></script>
</body>
</html>
{% endblock %}
---
=== app/templates/rocket.html ===
{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<style>
    :root {
        --primary: #00E676;
        --primary-hover: #00C853;
        --bg-dark: #121212;
        --bg-card: #1E1E1E;
        --bg-input: #2C2C2C;
        --text-primary: #FFFFFF;
        --text-secondary: #AAAAAA;
        --danger: #FF5252;
        --success: #00E676;
        --border-radius: 12px;
        --box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    }

    body {
        background-color: var(--bg-dark);
        color: var(--text-primary);
        font-family: 'Inter', 'Segoe UI', 'Arial', sans-serif;
        margin: 0;
        padding: 0;
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .game-container {
        position: relative;
        width: 100%;
        max-width: 480px;
        padding: 0 20px;
    }

    .rocket-animation {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
        overflow: hidden;
        opacity: 0;
        transition: opacity 0.5s ease;
    }

    .rocket-animation.active {
        opacity: 1;
    }

    .rocket {
        position: absolute;
        bottom: -100px;
        left: 50%;
        transform: translateX(-50%);
        width: 60px;
        height: 120px;
        background-image: url('/static/images/rocket2.png');
        background-size: contain;
        background-repeat: no-repeat;
        transition: bottom 0.1s linear;
    }

    .multiplier-container {
        background: linear-gradient(135deg, rgba(30, 30, 30, 0.8) 0%, rgba(20, 20, 20, 0.9) 100%);
        backdrop-filter: blur(10px);
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        padding: 2rem;
        margin-bottom: 2rem;
        text-align: center;
        transform: translateY(20px);
        opacity: 0;
        transition: transform 0.5s ease, opacity 0.5s ease;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .multiplier-container.show {
        transform: translateY(0);
        opacity: 1;
    }

    .multiplier-label {
        font-size: 1rem;
        color: var(--text-secondary);
        margin-bottom: 0.5rem;
    }

    .multiplier-value {
        font-size: 4rem;
        font-weight: 700;
        color: var(--primary);
        text-shadow: 0 0 20px rgba(0, 230, 118, 0.5);
        margin: 0;
        line-height: 1;
    }

    .game-card {
        background: linear-gradient(135deg, rgba(30, 30, 30, 0.8) 0%, rgba(20, 20, 20, 0.9) 100%);
        backdrop-filter: blur(10px);
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        padding: 2rem;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .game-title {
        text-align: center;
        margin-bottom: 1.5rem;
        font-size: 1.8rem;
        font-weight: 700;
        color: var(--text-primary);
        position: relative;
        display: inline-block;
        width: 100%;
    }

    .game-title::after {
        content: "🚀";
        position: absolute;
        right: 0;
        top: 50%;
        transform: translateY(-50%);
    }

    
    .bet-form {
        display: flex;
        flex-direction: column;
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-label {
        display: block;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
        color: var(--text-secondary);
    }

    .form-input {
        width: 100%;
        padding: 1rem;
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: var(--border-radius);
        background-color: var(--bg-input);
        color: var(--text-primary);
        font-size: 1rem;
        transition: border-color 0.3s ease, box-shadow 0.3s ease;
        text-align: left; /* Выравнивание текста по левому краю */
        box-sizing: border-box; /* Учитываем padding в общей ширине */
    }

    .form-input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 2px rgba(0, 230, 118, 0.2);
    }
    
    .btn {
        width: 100%;
        padding: 1rem;
        border: none;
        border-radius: var(--border-radius);
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 1rem;
    }

    .btn-primary {
        background-color: var(--primary);
        color: #000000;
    }

    .btn-primary:hover {
        background-color: var(--primary-hover);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 230, 118, 0.3);
    }

    .btn-primary:active {
        transform: translateY(0);
    }

    .btn-secondary {
        background-color: var(--danger);
        color: var(--text-primary);
        opacity: 0;
        transform: translateY(10px);
        pointer-events: none;
        transition: opacity 0.3s ease, transform 0.3s ease, background-color 0.3s ease;
    }

    .btn-secondary.show {
        opacity: 1;
        transform: translateY(0);
        pointer-events: auto;
    }

    .btn-secondary:hover {
        background-color: #FF1744;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(255, 82, 82, 0.3);
    }

    .btn-secondary:active {
        transform: translateY(0);
    }

    .result-container {
        margin-top: 1.5rem;
        padding: 1.5rem;
        border-radius: var(--border-radius);
        text-align: center;
        font-size: 1.2rem;
        font-weight: 600;
        opacity: 0;
        transform: translateY(20px);
        transition: opacity 0.5s ease, transform 0.5s ease, background-color 0.3s ease;
        background-color: rgba(30, 30, 30, 0.5);
        backdrop-filter: blur(5px);
    }

    .result-container.show {
        opacity: 1;
        transform: translateY(0);
    }

    .result-win {
        color: var(--success);
    }

    .result-lose {
        color: var(--danger);
    }

    @keyframes pulse {
        0% {
            transform: scale(1);
        }
        50% {
            transform: scale(1.05);
        }
        100% {
            transform: scale(1);
        }
    }

    .pulse {
        animation: pulse 1s infinite;
    }

    /* Rocket Animation */
    @keyframes fly {
        0% {
            bottom: -100px;
        }
        100% {
            bottom: 120%;
        }
    }

    .fly-away {
        animation: fly 2s forwards;
    }

    /* Убираем стрелки в поле ввода числа */
    /* Для Chrome, Safari, Edge, Opera */
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    /* Для Firefox */
    input[type=number] {
        -moz-appearance: textfield;
        text-align: left; /* Выравнивание текста по левому краю */
        padding-right: 1rem; /* Уменьшаем правый отступ */
        box-sizing: border-box; /* Учитываем padding в общей ширине */
        width: 100%; /* Полная ширина контейнера */
    }
</style>

<div class="game-container">
    <div class="rocket-animation" id="rocketAnimation">
        <div class="rocket" id="rocket"></div>
    </div>

    <div class="multiplier-container" id="multiplierContainer">
        <div class="multiplier-label">МНОЖИТЕЛЬ</div>
        <div class="multiplier-value" id="multiplierValue">1.0x</div>
    </div>

    <div class="game-card">
        <h1 class="game-title">Rocket Game</h1>
        
        <form id="betForm" class="bet-form">
            <div class="form-group">
                <label for="start_bet" class="form-label">Сумма ставки(₽):</label>
                <input type="number" id="start_bet" class="form-input" min="10" placeholder="Введите сумму ставки" required>
            </div>
            
            <button type="button" id="submitBtn" class="btn btn-primary">ПОДТВЕРДИТЬ</button>
            <button type="button" id="takeProfitBtn" class="btn btn-secondary">ЗАБРАТЬ ИКС</button>
        </form>

        <div id="result" class="result-container"></div>
    </div>
</div>

<script src="/static/js/check_token.js"></script>
<script src="/static/js/rocket.js"></script>
{% endblock %}

---
=== app/templates/trade.html ===
{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<style>
    /* Основные стили */
    body {
        background-color: #121212;
        color: #ffffff;
        font-family: 'Arial', sans-serif;
        margin: 0;
        padding: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
    }
    @keyframes container-color {
        0%   {left:0; top:0px;}
        20%  {background-color:rgba(139, 139, 139, 0.67);box-shadow: 0 4px 10px rgba(139, 139, 139, 0.67);}
    }
    .container {
        position: relative;
        background-color: #1e1e1e;
        padding: 4rem;
        border-radius: 10px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
        width: 100%;
        max-width: 400px;
        animation-name: container-color;
        animation-duration: 1s;
        transform: translateX(0px);
        transition:  transform 2s ease;
    }
    .container.show {
        transform: translateX(-400px);
    }        
    .title {
        text-align: center;
        margin-bottom: 1.5rem;
        font-size: 1.8rem;
        color: #00ff88;
    }
    /* Форма */
    .trade-form {
        display: flex;
        flex-direction: column;
    }
    .form-group {
        margin-bottom: 1rem;
    }
    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
        color: #cccccc;
    }
    .form-input {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid #333;
        border-radius: 5px;
        background-color: #2c2c2c;
        color: #ffffff;
        font-size: 1rem;
    }
    .form-input:focus {
        outline: none;
        border-color: #00ff88;
    }
    /* Кнопка */
    .submit-button {
        background-color: #00ff88;
        color: #121212;
        border: none;
        padding: 0.75rem;
        border-radius: 5px;
        font-size: 1rem;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }
    .submit-button:hover {
        background-color: #00cc66;
    }
    .result-container {
        margin-top: 1.5rem;
        padding: 1rem;
        background-color: #2c2c2c;
        border-radius: 5px;
        text-align: center;
        font-size: 1rem;
        color: #ffffff;
        opacity: 0;
        transform: translateY(20px);
        transition: opacity 0.5s ease, transform 0.5s ease;
    }
    .result-container.show {
        opacity: 1;
        transform: translateY(0);
    }
    
    .price-container {
        position: absolute;
        left: 50%;
        bottom: 75%;
        padding: 2rem;
        min-width: 200px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
        background-color: #1e1e1e;
        border-radius: 5px;
        text-align: center;
        font-size: 15pt;
        color: #ffffff;
        opacity: 0;
        transform: translateY(-30px);
        transition: opacity 2.5s ease, transform 1s ease;
        animation-name: container-color;
        animation-duration: 1s;
        z-index: 1000;
    }
    .price-container.show {
        transform: translateY(0px);
        opacity: 1;
    }

    .current-container {
        position: absolute;
        left: 75%;
        bottom: 75%;
        padding: 2rem;
        min-width: 200px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
        background-color: #1e1e1e;
        border-radius: 5px;
        text-align: center;
        font-size: 15pt;
        color: #ffffff;
        opacity: 0;
        transform: translateY(-30px);
        transition: opacity 2.5s ease, transform 1s ease;
        animation-name: container-color;
        animation-duration: 1s;
        z-index: 1000;
    }
    .current-container.show {
        transform: translateY(0px);
        opacity: 1;
    }

    .buy-container {
        position: absolute;
        top: -15px;
        left: -15px;
        
        font-size: 12pt;
        color:rgb(101, 101, 101);
        font-weight: bold;
        text-transform: uppercase;
        border-radius: 3px;
        background: rgba(30, 30, 30, 0.9);
        padding: 4px 8px;
        border-radius: 3px;
    }
    /* Убираем стрелки в поле ввода числа */
    /* Для Chrome, Safari, Edge, Opera */
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    /* Для Firefox */
    input[type=number] {
        -moz-appearance: textfield;
        text-align: left; /* Выравнивание текста по левому краю */
        padding-right: 1rem; /* Уменьшаем правый отступ */
        box-sizing: border-box; /* Учитываем padding в общей ширине */
        width: 100%; /* Полная ширина контейнера */
    }
</style>

<body>

    <div id="container1-show" class="price-container">
        <div class="buy-container">BUY</div>
        <div id="price-show"></div>

    </div>

    <div id="container2-show" class="current-container">
        <div class="buy-container">NOW</div>
        <div id="current-show"></div>
    </div>
    
    <div id="container-peredv" class="container">
        <h1 class="title">Торговля</h1>
        
        <form id="tradeForm" class="trade-form">
            <div class="form-group">
                <label for="currency">Выберите актив:</label>
                <select name="currency" id="currency" class="form-input">
                    <option value="BTC">Биткойн</option>
                    <option value="ETH">Эфириум</option>
                    <option value="SOL">Солана</option>
                </select>
            </div>

            <div class="form-group">
                <label for="amount">Сумма ставки(₽):</label>
                <input type="number" name="amount" id="amount" class="form-input" min="1" required>
            </div>

            <div class="form-group">
                <label for="leverage">Плечо:</label>
                <select name="leverage" id="leverage" class="form-input">
                    <option value="1">1x</option>
                    <option value="2">2x</option>
                    <option value="5">5x</option>
                    <option value="10">10x</option>
                    <option value="25">25x</option>
                    <option value="50">50x</option>
                    <option value="100">100x</option>
                </select>
            </div>

            <div class="form-group">
                <label for="direction">Направление:</label>
                <select name="direction" id="direction" class="form-input">
                    <option value="up">LONG</option>
                    <option value="down">SHORT</option>
                </select>
            </div>

            <div class="form-group">
                <label for="time">Время (минуты):</label>
                <input type="number" name="time" id="time" class="form-input" min="1" required>
            </div>

            <button type="submit" class="submit-button">Подтвердить</button>
        </form>

        <div id="result" class="result-container"></div>
    </div>
    <script src="/static/js/trade_front.js"></script>
    <script src="/static/js/check_token.js"></script>
</body>
{% endblock %}
---
=== app/templates/verify_email.html ===
{% extends "base.html" %}

{% block title %}{{title}}{% endblock %}

{% block content %}
    <div class="confirmation-message">
        <h1 style="color: green; text-align: center;">Страница подтверждена!</h1>
        <p style="text-align: center;">Почта успешно подтверждена</p>
        <p style="text-align: center;"><a href="/">Перейти на главную страницу</a></p>
    </div>
{% endblock %}
---
=== app/webapp/__init__.py ===
---
=== app/webapp/endpoints/__init__.py ===
---
=== app/webapp/endpoints/main_back.py ===
from fastapi import APIRouter, Depends, HTTPException, Request
from app.core.security import get_jwt_from_cookie
from app.api.classes.clsss import GetData
from app.core.database_con import AsyncSession, User, Account_Data, get_db
from fastapi.templating import Jinja2Templates
from fastapi.responses import RedirectResponse
import logging

templates = Jinja2Templates("app/templates")

router_main_back = APIRouter()


@router_main_back.get("/")
async def get_home_page(request: Request, token: str = Depends(get_jwt_from_cookie)):
    return templates.TemplateResponse(
        "mainpage.html", {"request": request, "title": "Nenaebalovo.ru", "token": token}
    )


@router_main_back.get("/login")
async def login(request: Request, token: str = Depends(get_jwt_from_cookie)):
    return templates.TemplateResponse(
        "login.html", {"request": request, "title": "Login", "token": token}
    )


@router_main_back.get("/register")
async def register(request: Request, token: str = Depends(get_jwt_from_cookie)):
    return templates.TemplateResponse(
        "register.html", {"request": request, "title": "Register", "token": token}
    )


@router_main_back.get("/trade")
async def trade(request: Request, token: str = Depends(get_jwt_from_cookie)):
    return templates.TemplateResponse(
        "trade.html", {"request": request, "title": "Trade", "token": token}
    )


@router_main_back.get("/rocket")
async def roulette(request: Request, token: str = Depends(get_jwt_from_cookie)):
    return templates.TemplateResponse(
        "rocket.html", {"request": request, "title": "Rocket", "token": token}
    )


@router_main_back.get("/account")
async def trade(
    request: Request,
    db: AsyncSession = Depends(get_db),
    token: str = Depends(get_jwt_from_cookie),
):
    user: User = await GetData(db, User).from_token(token)
    if user == "no token":
        return RedirectResponse(url="/")
    username = user.username
    account: Account_Data = await GetData(db, Account_Data).from_account_id(
        user.account_id
    )
    balance = account.balance
    user_email = account.email
    is_verified = account.is_verified

    return templates.TemplateResponse(
        "account.html",
        {
            "token": token,
            "request": request,
            "title": "Account",
            "username": username,
            "balance": balance,
            "email": user_email,
            "is_verified": is_verified,
        },
    )
---
=== app/webapp/models/__init__.py ===
---
=== app/webapp/models/trade.py ===
from pydantic import BaseModel


class Trade_Form(BaseModel):
    exchange: str
    bet_amount: float
    leverage: int
    direction: str
    time: int

    class Config:
        from_attributes = True


class Trade_EndResult(BaseModel):
    trade_id: int
    end_price: float

    class Config:
        from_attributes = True
---
=== docker-compose.yml ===
networks:
  app-tier:
    driver: bridge

services:
  fastapi:
    build: .
    command: uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
    volumes:
      - .:/app
    ports:
      - "8000:8000"
    depends_on:
      - db
      - redis
    environment:
      - DATABASE_URL=${DATABASE_URL}
    env_file:
      - .env
    networks:
      - app-tier

  celery:
    build: .
    command: celery -A app.core.celery_con worker --loglevel=info
    volumes:
      - .:/app
    depends_on:
      - redis
      - db
    environment:
      - DATABASE_URL=${DATABASE_URL}
    env_file:
      - .env
    networks:
      - app-tier

  redis:
    image: "redis:latest"
    ports:
      - "6379:6379"
    networks:
      - app-tier

  db:
    image: "postgres:latest"
    environment:
      - POSTGRES_USER=${DB_USER}
      - POSTGRES_PASSWORD=${DB_PASSWORD}
      - POSTGRES_DB=${DB_NAME}
    ports:
      - "5433:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - app-tier

  tests:
    build: .
    volumes:
      - .:/app
    command: pytest -v
    depends_on:
      - redis
      - celery
      - db
    networks:
      - app-tier


volumes:
  postgres_data:
---
=== pytest.ini ===
# pytest.ini
[pytest]
asyncio_mode = strict
asyncio_default_fixture_loop_scope = function
filterwarnings = ignore::DeprecationWarning
---
=== requirements.txt ===
aiosmtplib==3.0.2
alembic==1.14.1
amqp==5.3.1
annotated-types==0.7.0
anyio==4.8.0
async-timeout==5.0.1
asyncpg==0.30.0
bcrypt==4.0.1
billiard==4.2.1
blinker==1.9.0
celery==5.4.0
certifi==2024.12.14
charset-normalizer==3.4.1
click==8.1.8
click-didyoumean==0.3.1
click-plugins==1.1.1
click-repl==0.3.0
dnspython==2.7.0
email_validator==2.2.0
fastapi==0.115.7
fastapi-cli==0.0.7
fastapi-mail==1.4.2
greenlet==3.1.1
h11==0.14.0
httpcore==1.0.7
httptools==0.6.4
httpx==0.28.1
idna==3.10
iniconfig==2.1.0
itsdangerous==2.2.0
Jinja2==3.1.5
kafka-python==2.1.1
kombu==5.4.2
Mako==1.3.8
markdown-it-py==3.0.0
MarkupSafe==3.0.2
mdurl==0.1.2
orjson==3.10.15
packaging==25.0
passlib==1.7.4
pluggy==1.5.0
prompt_toolkit==3.0.50
psycopg2-binary==2.9.10
pydantic==2.10.6
pydantic-extra-types==2.10.2
pydantic-settings==2.7.1
pydantic_core==2.27.2
Pygments==2.19.1
PyJWT==2.10.1
pytest==8.3.5
pytest-asyncio==0.26.0
python-dateutil==2.9.0.post0
python-dotenv==1.0.1
python-multipart==0.0.20
PyYAML==6.0.2
redis==5.2.1
requests==2.32.3
rich==13.9.4
rich-toolkit==0.13.2
shellingham==1.5.4
six==1.17.0
sniffio==1.3.1
SQLAlchemy==2.0.37
starlette==0.45.3
typer==0.15.1
typing_extensions==4.12.2
tzdata==2025.1
ujson==5.10.0
urllib3==2.3.0
uvicorn==0.34.0
uvloop==0.21.0
vine==5.1.0
watchfiles==1.0.4
wcwidth==0.2.13
websockets==14.2
---
=== tests/__init__.py ===
---
=== tests/test_api.py ===
"""
------------------START TESTS------------------
make tests

"""


import pytest
from httpx import AsyncClient, ASGITransport
from app.api.endpoints.users import router_users


@pytest.mark.asyncio
async def test_login():
    async with AsyncClient(
        transport=ASGITransport(router_users), base_url="http://test"
    ) as ac:
        login_data = {"id": None, "username": "", "password": ""}
        response = await ac.post("/api/v1/auth/login/", json=login_data)

    assert response.status_code == 200
---
